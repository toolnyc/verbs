---
import type { Event, TicketTier } from '../../lib/supabase';
import TicketTierButton from './TicketTier.astro';

interface Props {
  event: Event & { ticket_tiers?: TicketTier[] };
  compact?: boolean;
}

const { event, compact = false } = Astro.props;

const eventDate = new Date(event.date);
const isPast = eventDate < new Date();

const formattedDate = eventDate.toLocaleDateString('en-US', {
  weekday: 'short',
  month: 'short',
  day: 'numeric',
});

// Format time in 24-hour military format
const formattedTime = eventDate.toLocaleTimeString('en-GB', {
  hour: '2-digit',
  minute: '2-digit',
  hour12: false,
  timeZone: event.timezone || 'America/New_York',
});

const tiers = (event.ticket_tiers || []).filter(t => t.is_active);
---

<article class="event-card card-hover" class:list={{ past: isPast, compact }}>
  <div class="event-image-wrapper img-hover-reveal">
    {event.image_url ? (
      <img src={event.image_url} alt={event.title} class="event-image" />
    ) : (
      <div class="event-image img-placeholder"></div>
    )}
    <div class="event-date-overlay">
      <span class="date-day">{eventDate.getDate()}</span>
      <span class="date-month">{eventDate.toLocaleDateString('en-US', { month: 'short' })}</span>
    </div>
  </div>

  <div class="event-details">
    <h3 class="event-title">{event.title}</h3>
    <p class="event-meta text-sm text-muted">
      {event.venue_name} Â· {formattedTime}
    </p>
    <p class="event-city text-xs text-muted">{event.venue_city}</p>
  </div>

  {!compact && !isPast && tiers.length > 0 && (
    <div class="event-tickets">
      {tiers.slice(0, 1).map(tier => (
        <TicketTierButton tier={tier} eventId={event.id} />
      ))}
    </div>
  )}

  {isPast && (
    <div class="event-status">
      <span class="badge">Past</span>
    </div>
  )}
</article>

<style>
  .event-card {
    display: flex;
    flex-direction: column;
    width: 320px;
    background: var(--color-bg);
  }

  .event-card.past {
    opacity: 0.5;
  }

  .event-card.compact {
    width: 280px;
  }

  .event-image-wrapper {
    position: relative;
    aspect-ratio: 4/5;
    background: var(--color-bg-alt);
  }

  .event-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .img-placeholder {
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, var(--color-bg-alt) 0%, var(--color-border) 100%);
  }

  .event-date-overlay {
    position: absolute;
    bottom: var(--space-md);
    left: var(--space-md);
    display: flex;
    flex-direction: column;
    background: var(--color-bg);
    padding: var(--space-sm) var(--space-md);
    line-height: 1.1;
  }

  .date-day {
    font-size: var(--text-3xl);
    font-weight: 500;
  }

  .date-month {
    font-size: var(--text-xs);
    color: var(--color-muted);
  }

  .event-details {
    padding: var(--space-lg) 0;
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
  }

  .event-title {
    font-size: var(--text-xl);
    font-weight: 500;
    line-height: 1.2;
  }

  .event-tickets {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
  }

  .event-status {
    margin-top: var(--space-sm);
  }

  @media (max-width: 480px) {
    .event-card {
      width: 280px;
    }

    .event-card.compact {
      width: 240px;
    }
  }
</style>
