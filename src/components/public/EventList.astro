---
import type { Event, TicketTier } from '../../lib/supabase';
import EventCard from './EventCard.astro';

interface Props {
  events: (Event & { ticket_tiers?: TicketTier[] })[];
  excludeId?: string;
}

const { events, excludeId } = Astro.props;

// Filter out the excluded event (hero event) and group by year/month
const filteredEvents = excludeId
  ? events.filter(e => e.id !== excludeId)
  : events;

// Group events by year
const eventsByYear = filteredEvents.reduce((acc, event) => {
  const year = new Date(event.date).getFullYear();
  if (!acc[year]) acc[year] = [];
  acc[year].push(event);
  return acc;
}, {} as Record<number, typeof filteredEvents>);

// Sort years descending for past, ascending for future
const currentYear = new Date().getFullYear();
const years = Object.keys(eventsByYear)
  .map(Number)
  .sort((a, b) => {
    // Future years first (ascending), then past years (descending)
    const aIsFuture = a >= currentYear;
    const bIsFuture = b >= currentYear;
    if (aIsFuture && !bIsFuture) return -1;
    if (!aIsFuture && bIsFuture) return 1;
    if (aIsFuture) return a - b;
    return b - a;
  });
---

<section class="events-list">
  <div class="container">
    <div class="section-header">
      <h2 class="section-title display-text">Events</h2>
      <div class="scroll-indicator">
        <span>Scroll</span>
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M5 12h14M12 5l7 7-7 7"/>
        </svg>
      </div>
    </div>
  </div>

  {years.map(year => (
    <div class="year-group">
      <div class="container">
        <h3 class="year-header">{year}</h3>
      </div>
      <div class="events-scroll horizontal-scroll">
        {eventsByYear[year].map(event => (
          <EventCard event={event} />
        ))}
      </div>
    </div>
  ))}

  {filteredEvents.length === 0 && (
    <div class="container">
      <p class="no-events text-muted">No events to show</p>
    </div>
  )}
</section>

<style>
  .events-list {
    padding: var(--space-4xl) 0;
  }

  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    margin-bottom: var(--space-3xl);
  }

  .section-title {
    margin-bottom: 0;
  }

  .year-group {
    margin-bottom: var(--space-4xl);
  }

  .year-header {
    font-size: var(--text-4xl);
    color: var(--color-muted);
    margin-bottom: var(--space-lg);
    font-weight: 500;
  }

  .events-scroll {
    gap: var(--space-xl);
  }

  .no-events {
    padding: var(--space-2xl) 0;
  }

  @media (max-width: 768px) {
    .section-header {
      flex-direction: column;
      align-items: flex-start;
      gap: var(--space-md);
    }
  }
</style>
