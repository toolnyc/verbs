---
// Footer component - pinned at bottom, content scrolls beneath
interface Props {
  nextEventDate?: string | null;
}

const { nextEventDate } = Astro.props;
---

<footer class="site-footer" data-next-event={nextEventDate || ''}>
  <!-- Desktop footer - expandable -->
  <div class="footer-desktop" id="footer-desktop">
    <!-- Main row: always visible -->
    <div class="footer-bar footer-main-row">
      <form class="newsletter-form" id="newsletter-form-desktop">
        <input type="email" name="email" placeholder="Email for updates" required />
        <button type="submit">Subscribe</button>
        <span class="newsletter-status"></span>
      </form>

      <a href="/" class="footer-home no-underline" aria-label="VERBS Home">
        <svg class="footer-logo" viewBox="0 0 297.67 297.67" aria-hidden="true">
          <!-- Outer circle - static -->
          <circle class="logo-ring" cx="148.83" cy="148.83" r="147.83" fill="none" stroke="#fff" stroke-width="2"/>
          <!-- Inner content - spins -->
          <g class="logo-spin" fill="#fff">
            <path d="M60.98,30.96c-.08-1.37.97-2.54,2.34-2.62l87.7-4.93c37.09-2.08,69.54,13.17,71.62,50.25,1.17,20.83-8.67,36.16-27.24,45.87l.04.76c15.05,4.76,23.24,14.49,27.08,28.55,6.05,21.57,3.46,47.97,10.16,49.37l.16,2.79-52.33,2.94c-5.28-3.27-4.5-25.74-9.23-41.78-4.09-13.78-10.58-20.55-26.08-19.68l-24.64,1.38,3.55,63.25-53.09,2.98L60.98,30.96ZM118.45,106.02l28.45-1.6c15.24-.86,23.25-7.93,22.54-20.63-.67-11.94-8.72-19.13-23.96-18.27l-29.21,1.64,2.18,38.86Z"/>
            <path d="M296.22,137.32c-2.45-43.64-24.84-81.49-56.9-106.8l9.42,167.6,39.84-2.47c6.65-18.16,8.79-37.85,7.64-58.33Z"/>
            <path d="M15.12,214.06l42.76-2.67-2.83-45.3-53.51,3.35c2.19,15.94,6.79,30.8,13.58,44.62Z"/>
            <path d="M19.98,75.31l26.75-1.67-1.93-30.86c-9.87,9.54-17.91,20.62-24.82,32.53Z"/>
            <path d="M33.83,99.09l-25.51,1.55c-4.47,12.69-7.2,26.51-7.97,40.43l35.96-2.25-2.48-39.73Z"/>
            <path d="M23.09,226.62c14.1,22.75,34.17,41.29,57.89,53.57h135.74c23.86-12.35,43.81-30.97,57.82-53.57H23.09Z"/>
          </g>
        </svg>
      </a>

      <div class="footer-right">
        <div class="footer-countdown">
          <span class="countdown-label">Next party</span>
          <span class="countdown-value" id="countdown-desktop">--</span>
        </div>
        <button class="footer-expand-toggle" id="footer-expand-toggle" aria-label="Expand menu">
          <span class="expand-icon">+</span>
          <span class="collapse-icon">âˆ’</span>
        </button>
      </div>
    </div>

    <!-- Second row: hidden by default -->
    <div class="footer-bar footer-second-row" id="footer-second-row">
      <a href="/legal">Legal</a>
      <a href="/admin">Admin</a>
    </div>
  </div>

  <!-- Mobile footer bar -->
  <div class="footer-bar footer-mobile">
    <button class="footer-menu-toggle" id="footer-menu-toggle">Menu</button>
    <div class="footer-countdown">
      <span class="countdown-label">Next party</span>
      <span class="countdown-value" id="countdown-mobile">--</span>
    </div>
  </div>
</footer>

<!-- Full screen mobile menu -->
<div class="footer-menu-overlay" id="footer-menu-overlay">
  <button class="footer-menu-close" id="footer-menu-close">Close</button>
  <nav class="footer-menu-nav">
    <a href="/">Home</a>
    <a href="/legal">Legal</a>
    <a href="/admin">Admin</a>
  </nav>
  <form class="newsletter-form newsletter-form-overlay" id="newsletter-form-overlay">
    <input type="email" name="email" placeholder="Email for updates" required />
    <button type="submit">Subscribe</button>
    <span class="newsletter-status"></span>
  </form>
  <div class="footer-countdown-overlay">
    <span class="countdown-label">Next party</span>
    <span class="countdown-value" id="countdown-overlay">--</span>
  </div>
</div>

<script>
  // Use window to persist interval across ViewTransitions
  declare global {
    interface Window {
      _countdownInterval?: number;
    }
  }

  function updateCountdown() {
    const footer = document.querySelector('.site-footer') as HTMLElement;
    const nextEventDate = footer?.dataset.nextEvent;

    const elements = document.querySelectorAll('#countdown-desktop, #countdown-mobile, #countdown-overlay');

    if (!nextEventDate) {
      elements.forEach(el => {
        if (el) el.textContent = 'TBA';
      });
      return;
    }

    const now = new Date();
    const eventDate = new Date(nextEventDate);
    const diff = eventDate.getTime() - now.getTime();

    if (isNaN(diff)) {
      elements.forEach(el => {
        if (el) el.textContent = 'TBA';
      });
      return;
    }

    if (diff <= 0) {
      elements.forEach(el => {
        if (el) el.textContent = 'Now!';
      });
      return;
    }

    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((diff % (1000 * 60)) / 1000);

    let countdownText = '';
    if (days > 0) {
      countdownText = `${days}d ${hours}h ${minutes}m`;
    } else if (hours > 0) {
      countdownText = `${hours}h ${minutes}m ${seconds}s`;
    } else {
      countdownText = `${minutes}m ${seconds}s`;
    }

    elements.forEach(el => {
      if (el) el.textContent = countdownText;
    });
  }

  function initCountdown() {
    // Clear any existing interval
    if (window._countdownInterval) {
      clearInterval(window._countdownInterval);
    }

    // Update immediately and then every second
    updateCountdown();
    window._countdownInterval = window.setInterval(updateCountdown, 1000);
  }

  // Initialize countdown
  initCountdown();

  // Re-initialize after ViewTransitions
  document.addEventListener('astro:page-load', initCountdown);

  // Desktop footer expand/collapse
  const footerDesktop = document.getElementById('footer-desktop');
  const expandToggle = document.getElementById('footer-expand-toggle');

  expandToggle?.addEventListener('click', () => {
    footerDesktop?.classList.toggle('expanded');
  });

  // Mobile menu toggle
  const menuToggle = document.getElementById('footer-menu-toggle');
  const menuClose = document.getElementById('footer-menu-close');
  const menuOverlay = document.getElementById('footer-menu-overlay');

  menuToggle?.addEventListener('click', () => {
    menuOverlay?.classList.add('open');
    document.body.style.overflow = 'hidden';
  });

  menuClose?.addEventListener('click', () => {
    menuOverlay?.classList.remove('open');
    document.body.style.overflow = '';
  });

  // Close menu when clicking a link
  menuOverlay?.querySelectorAll('a').forEach(link => {
    link.addEventListener('click', () => {
      menuOverlay?.classList.remove('open');
      document.body.style.overflow = '';
    });
  });

  // Newsletter form handling
  document.querySelectorAll('.newsletter-form').forEach(form => {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formEl = e.target as HTMLFormElement;
      const emailInput = formEl.querySelector('input[name="email"]') as HTMLInputElement;
      const statusEl = formEl.querySelector('.newsletter-status') as HTMLElement;
      const submitBtn = formEl.querySelector('button[type="submit"]') as HTMLButtonElement;

      const email = emailInput.value;
      submitBtn.disabled = true;
      statusEl.textContent = '...';

      try {
        const res = await fetch('/api/newsletter', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });

        if (res.ok) {
          statusEl.textContent = 'Subscribed!';
          emailInput.value = '';
        } else {
          const data = await res.json();
          statusEl.textContent = data.error || 'Error';
        }
      } catch {
        statusEl.textContent = 'Error';
      }

      submitBtn.disabled = false;
      setTimeout(() => { statusEl.textContent = ''; }, 3000);
    });
  });
</script>

<style>
  .site-footer {
    position: fixed;
    bottom: var(--space-md);
    left: 50%;
    transform: translateX(-50%);
    z-index: 100;
    background: var(--color-fg);
    color: var(--color-bg);
    border-radius: 2px;
    width: calc(100% - var(--space-xl) * 2);
    max-width: 900px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
  }

  .footer-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-md) var(--space-lg);
    height: auto;
    min-height: 56px;
  }

  .footer-desktop {
    display: block;
  }

  .footer-mobile {
    display: none;
  }

  .newsletter-form {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
  }

  .newsletter-form input {
    background: transparent;
    border: 1px solid var(--color-bg);
    color: var(--color-bg);
    padding: var(--space-xs) var(--space-sm);
    font-size: var(--text-sm);
    width: 180px;
  }

  .newsletter-form input::placeholder {
    color: rgba(255, 255, 255, 0.5);
  }

  .newsletter-form input:focus {
    outline: 1px solid var(--color-bg);
    outline-offset: 1px;
  }

  .newsletter-form button {
    background: var(--color-bg);
    color: var(--color-fg);
    border: 1px solid var(--color-bg);
    padding: var(--space-xs) var(--space-sm);
    font-size: var(--text-sm);
  }

  .newsletter-form button:hover {
    background: transparent;
    color: var(--color-bg);
  }

  .newsletter-status {
    font-size: var(--text-xs);
    opacity: 0.7;
  }

  .footer-home {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .footer-logo {
    height: 36px;
    width: 36px;
  }

  .footer-logo .logo-spin {
    transform-origin: center;
    animation: spin 12s linear infinite;
  }

  @keyframes spin {
    from {
      transform: rotate(0deg);
    }
    to {
      transform: rotate(360deg);
    }
  }

  .footer-right {
    display: flex;
    align-items: center;
    gap: var(--space-lg);
  }

  .footer-countdown {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    font-size: var(--text-base);
  }

  .countdown-label {
    opacity: 0.6;
  }

  .countdown-value {
    font-variant-numeric: tabular-nums;
  }

  /* Desktop expand toggle */
  .footer-expand-toggle {
    background: transparent;
    border: 1px solid var(--color-bg);
    color: var(--color-bg);
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: var(--text-base);
    cursor: pointer;
    flex-shrink: 0;
  }

  .footer-expand-toggle:hover {
    background: var(--color-bg);
    color: var(--color-fg);
  }

  .footer-expand-toggle .collapse-icon {
    display: none;
  }

  .footer-desktop.expanded .footer-expand-toggle .expand-icon {
    display: none;
  }

  .footer-desktop.expanded .footer-expand-toggle .collapse-icon {
    display: inline;
  }

  /* Second row - hidden by default */
  .footer-second-row {
    display: none;
    justify-content: center;
    gap: var(--space-xl);
    min-height: 44px;
    border-top: 1px solid rgba(255, 255, 255, 0.15);
  }

  .footer-second-row a {
    font-size: var(--text-sm);
    opacity: 0.7;
  }

  .footer-second-row a:hover {
    opacity: 1;
  }

  .footer-desktop.expanded .footer-second-row {
    display: flex;
  }

  /* Mobile footer */
  .footer-menu-toggle {
    background: transparent;
    border: none;
    padding: var(--space-sm) 0;
    font-size: var(--text-base);
    cursor: pointer;
    color: var(--color-bg);
  }

  .footer-menu-toggle:hover {
    background: transparent;
    color: var(--color-bg);
    opacity: 0.7;
  }

  /* Full screen overlay */
  .footer-menu-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: var(--color-fg);
    color: var(--color-bg);
    z-index: 1100;
    flex-direction: column;
    padding: var(--space-xl);
  }

  .footer-menu-overlay.open {
    display: flex;
  }

  .footer-menu-close {
    position: absolute;
    top: var(--space-md);
    right: var(--space-md);
    background: transparent;
    border: none;
    color: var(--color-bg);
    font-size: var(--text-sm);
    cursor: pointer;
    padding: var(--space-sm) var(--space-md);
  }

  .footer-menu-close:hover {
    background: transparent;
    opacity: 0.7;
  }

  .footer-menu-nav {
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
    margin-top: var(--space-3xl);
    flex: 1;
  }

  .footer-menu-nav a {
    font-size: var(--text-2xl);
    font-weight: 700;
    color: inherit;
    text-decoration: none;
    opacity: 0.7;
    padding: var(--space-sm) 0;
  }

  .footer-menu-nav a::after {
    display: none;
  }

  .footer-menu-nav a:hover {
    opacity: 1;
  }

  .footer-countdown-overlay {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    font-size: var(--text-sm);
    padding-top: var(--space-xl);
    border-top: 1px solid rgba(255, 255, 255, 0.2);
  }

  .footer-countdown-overlay .countdown-label {
    opacity: 0.6;
  }

  .newsletter-form-overlay {
    flex-direction: column;
    align-items: flex-start;
    gap: var(--space-md);
    margin-top: var(--space-xl);
  }

  .newsletter-form-overlay input {
    width: 100%;
    padding: var(--space-sm) var(--space-md);
    font-size: var(--text-base);
  }

  .newsletter-form-overlay button {
    padding: var(--space-sm) var(--space-lg);
    font-size: var(--text-base);
  }

  @media (max-width: 768px) {
    .footer-desktop {
      display: none;
    }

    .footer-mobile {
      display: flex;
    }
  }
</style>
