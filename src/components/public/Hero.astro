---
import type { Event, TicketTier, DJ } from '../../lib/supabase';
import TicketTierButton from './TicketTier.astro';

interface Props {
  event: Event;
  tiers: TicketTier[];
  djs: DJ[];
}

const { event, tiers, djs } = Astro.props;

const eventDate = new Date(event.date);
const isPast = eventDate < new Date();

const formattedDate = eventDate.toLocaleDateString('en-US', {
  weekday: 'long',
  month: 'long',
  day: 'numeric',
});

// Format time in 24-hour military format with timezone
const formattedTime = eventDate.toLocaleTimeString('en-GB', {
  hour: '2-digit',
  minute: '2-digit',
  hour12: false,
  timeZone: event.timezone || 'America/New_York',
});

// Get short timezone abbreviation
const timezoneAbbr = new Intl.DateTimeFormat('en-US', {
  timeZone: event.timezone || 'America/New_York',
  timeZoneName: 'short',
}).formatToParts(eventDate).find(p => p.type === 'timeZoneName')?.value || '';

const formattedYear = eventDate.getFullYear();
---

<section class="hero" class:list={{ past: isPast }}>
  <div class="hero-image-wrapper img-hover-reveal">
    {(event.flyer_url || event.image_url) && (
      <img src={event.flyer_url || event.image_url} alt={event.title} class="hero-bg-image" />
    )}
  </div>

  <div class="container hero-container">
    <header class="hero-header">
      <div class="hero-meta">
        <span class="date-pill">{formattedDate}</span>
        <span class="year-pill">{formattedYear}</span>
      </div>
      <h1 class="title display-text">{event.title}</h1>
    </header>

    <div class="hero-content">
      <div class="hero-info">
        <div class="venue">
          <p class="venue-name">{event.venue_name}</p>
          <p class="venue-city text-muted">{event.venue_city}</p>
          {event.venue_link && (
            <a href={event.venue_link} target="_blank" rel="noopener" class="venue-link text-sm">
              View map
            </a>
          )}
        </div>

        <div class="time">
          <p class="time-main">{formattedTime}{event.time_end && ` — ${new Date(event.time_end).toLocaleTimeString('en-GB', {
            hour: '2-digit',
            minute: '2-digit',
            hour12: false,
            timeZone: event.timezone || 'America/New_York',
          })}`} <span class="text-muted">{timezoneAbbr}</span></p>
        </div>

        {djs.length > 0 && (
          <div class="lineup">
            <p class="text-xs text-muted mb-sm">Lineup</p>
            <ul class="dj-list">
              {djs.map((dj: any) => (
                <li class="dj-name">
                  {dj.name}
                  {(dj.slot_start || dj.slot_end) && (
                    <span class="dj-time text-muted">
                      {dj.slot_start && dj.slot_start.slice(0, 5)}
                      {dj.slot_start && dj.slot_end && ' — '}
                      {dj.slot_end && dj.slot_end.slice(0, 5)}
                    </span>
                  )}
                </li>
              ))}
            </ul>
          </div>
        )}

        {event.description && (
          <div class="description">
            <p>{event.description}</p>
          </div>
        )}
      </div>

      <div class="hero-tickets">
        {!isPast && tiers.length > 0 && (
          <div class="tickets">
            {tiers.map(tier => (
              <TicketTierButton tier={tier} eventId={event.id} />
            ))}
          </div>
        )}

        {isPast && (
          <p class="text-muted text-sm">This event has passed</p>
        )}
      </div>
    </div>
  </div>
</section>

<style>
  .hero {
    position: relative;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  .hero.past {
    min-height: auto;
  }

  .hero.past .hero-image-wrapper {
    opacity: 0.4;
  }

  .hero-image-wrapper {
    position: absolute;
    top: 0;
    right: 0;
    width: 55%;
    height: 100%;
    z-index: 0;
  }

  .hero-bg-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .hero-container {
    position: relative;
    z-index: 1;
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    padding-top: var(--space-4xl);
    padding-bottom: var(--space-4xl);
  }

  .hero-header {
    margin-bottom: var(--space-3xl);
  }

  .hero-meta {
    display: flex;
    gap: var(--space-sm);
    margin-bottom: var(--space-lg);
  }

  .date-pill,
  .year-pill {
    display: inline-block;
    font-size: var(--text-xs);
    padding: var(--space-xs) var(--space-md);
    border: 1px solid var(--color-fg);
  }

  .title {
    max-width: 10ch;
  }

  .hero-content {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--space-3xl);
    max-width: 600px;
  }

  .hero-info {
    display: flex;
    flex-direction: column;
    gap: var(--space-xl);
  }

  .venue-name {
    font-size: var(--text-2xl);
    font-weight: 500;
  }

  .venue-link {
    display: inline-block;
    margin-top: var(--space-xs);
  }

  .time-main {
    font-size: var(--text-xl);
  }

  .dj-list {
    list-style: none;
  }

  .dj-name {
    font-size: var(--text-lg);
    padding: var(--space-sm) 0;
    border-bottom: 1px solid var(--color-border);
    transition: padding-left 0.2s ease;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: var(--space-md);
  }

  .dj-name:hover {
    padding-left: var(--space-sm);
  }

  .dj-name:last-child {
    border-bottom: none;
  }

  .dj-time {
    font-size: var(--text-sm);
    font-variant-numeric: tabular-nums;
  }

  .description {
    max-width: 45ch;
    line-height: 1.6;
  }

  .hero-tickets {
    display: flex;
    flex-direction: column;
    gap: var(--space-lg);
  }

  .tickets {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
  }

  @media (max-width: 1024px) {
    .hero-image-wrapper {
      width: 45%;
    }
  }

  @media (max-width: 768px) {
    .hero {
      min-height: auto;
    }

    .hero-image-wrapper {
      position: relative;
      width: 100%;
      height: 50vh;
      order: -1;
    }

    .hero-container {
      padding-top: var(--space-2xl);
    }

    .title {
      max-width: none;
    }
  }
</style>
