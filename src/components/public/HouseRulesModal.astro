---
// House Rules Modal - render once per page where ticket purchase is available
import { getSiteContentByGroup } from '../../lib/supabase';

// Fetch house rules content from database
const houseRules = await getSiteContentByGroup('house_rules');
---

<div id="house-rules-modal" class="modal" aria-hidden="true">
  <div class="modal-backdrop"></div>
  <div class="modal-content">
    <div class="ticket-selection">
      <div class="tier-header">
        <span class="tier-name-display" id="modal-tier-name"></span>
        <span class="tier-price-display" id="modal-tier-price"></span>
      </div>
      <div class="quantity-selector">
        <span class="quantity-label">Quantity</span>
        <div class="quantity-controls">
          <button type="button" class="qty-btn" id="qty-decrease" aria-label="Decrease quantity">−</button>
          <span class="qty-value" id="qty-value">1</span>
          <button type="button" class="qty-btn" id="qty-increase" aria-label="Increase quantity">+</button>
        </div>
      </div>
      <div class="total-row">
        <span class="total-label">Total</span>
        <span class="total-value" id="modal-total"></span>
      </div>
    </div>

    <h2 class="modal-title">House Rules</h2>

    {houseRules.map(rule => (
      <div class="rules-section">
        <h3 class="rules-heading">{rule.title}</h3>
        <div class="rules-content" set:html={rule.content} />
      </div>
    ))}

    <div class="modal-actions">
      <label class="agreement-label">
        <input type="checkbox" id="rules-agreement" />
        <span>I agree to the house rules</span>
      </label>
      <div class="action-buttons">
        <button type="button" class="cancel-btn secondary" data-close-modal>Cancel</button>
        <button type="button" class="proceed-btn" id="proceed-checkout" disabled>Proceed to checkout</button>
      </div>
    </div>
  </div>
</div>

<style>
  .modal {
    position: fixed;
    inset: 0;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.2s, visibility 0.2s;
  }

  .modal[aria-hidden="false"] {
    opacity: 1;
    visibility: visible;
  }

  .modal-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.7);
  }

  .modal-content {
    position: relative;
    background: var(--color-bg);
    padding: var(--space-xl);
    max-width: 560px;
    width: calc(100% - var(--space-xl) * 2);
    max-height: calc(100vh - var(--space-xl) * 2);
    overflow-y: auto;
  }

  .ticket-selection {
    margin-bottom: var(--space-xl);
    padding-bottom: var(--space-lg);
    border-bottom: 1px solid var(--color-border);
  }

  .tier-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-md);
  }

  .tier-name-display {
    font-weight: 500;
  }

  .tier-price-display {
    color: var(--color-muted);
    font-size: var(--text-sm);
  }

  .quantity-selector {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-md);
  }

  .quantity-label {
    font-size: var(--text-sm);
    color: var(--color-muted);
  }

  .quantity-controls {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
  }

  .qty-btn {
    width: 32px;
    height: 32px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: var(--text-lg);
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    cursor: pointer;
    transition: background 0.15s, border-color 0.15s;
  }

  .qty-btn:hover:not(:disabled) {
    border-color: var(--color-fg);
  }

  .qty-btn:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }

  .qty-value {
    min-width: 32px;
    text-align: center;
    font-weight: 500;
    font-variant-numeric: tabular-nums;
  }

  .total-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: var(--space-md);
    border-top: 1px solid var(--color-border);
  }

  .total-label {
    font-weight: 500;
  }

  .total-value {
    font-size: var(--text-lg);
    font-weight: 500;
  }

  .modal-title {
    font-size: var(--text-2xl);
    margin-bottom: var(--space-xl);
  }

  .rules-section {
    margin-bottom: var(--space-lg);
  }

  .rules-heading {
    font-size: var(--text-sm);
    color: var(--color-muted);
    margin-bottom: var(--space-sm);
  }

  .rules-list {
    list-style: none;
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
  }

  .rules-list li {
    font-size: var(--text-sm);
    line-height: 1.5;
    padding-left: var(--space-md);
    position: relative;
  }

  .rules-list li::before {
    content: '—';
    position: absolute;
    left: 0;
    color: var(--color-muted);
  }

  /* Dynamic rules content from database */
  .rules-content {
    font-size: var(--text-sm);
    line-height: 1.5;
  }

  .rules-content :global(ul) {
    list-style: none;
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
    margin: 0;
    padding: 0;
  }

  .rules-content :global(li) {
    padding-left: var(--space-md);
    position: relative;
  }

  .rules-content :global(li)::before {
    content: '—';
    position: absolute;
    left: 0;
    color: var(--color-muted);
  }

  .modal-actions {
    margin-top: var(--space-xl);
    padding-top: var(--space-lg);
    border-top: 1px solid var(--color-border);
  }

  .agreement-label {
    display: flex;
    align-items: flex-start;
    gap: var(--space-sm);
    cursor: pointer;
    font-size: var(--text-sm);
  }

  .agreement-label input[type="checkbox"] {
    width: auto;
    margin-top: 2px;
  }

  .action-buttons {
    display: flex;
    gap: var(--space-sm);
    margin-top: var(--space-lg);
  }

  .action-buttons button {
    flex: 1;
  }

  .proceed-btn:disabled {
    opacity: 0.4;
    cursor: not-allowed;
  }

  .proceed-btn:not(:disabled) {
    background: var(--color-green);
    border-color: var(--color-green);
    color: var(--color-fg);
  }

  .proceed-btn:not(:disabled):hover {
    background: var(--color-fg);
    border-color: var(--color-fg);
    color: var(--color-bg);
  }
</style>

<script>
  // Store pending checkout details
  let pendingCheckout: {
    eventId: string;
    tierId: string;
    tierName: string;
    price: number;
    maxQuantity: number;
    quantity: number;
  } | null = null;

  function getModal() {
    return document.getElementById('house-rules-modal');
  }

  function getCheckbox() {
    return document.getElementById('rules-agreement') as HTMLInputElement | null;
  }

  function getProceedBtn() {
    return document.getElementById('proceed-checkout') as HTMLButtonElement | null;
  }

  function formatCurrency(amount: number): string {
    return new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency: 'USD',
    }).format(amount);
  }

  function updateModalDisplay() {
    if (!pendingCheckout) return;

    const tierNameEl = document.getElementById('modal-tier-name');
    const tierPriceEl = document.getElementById('modal-tier-price');
    const qtyValueEl = document.getElementById('qty-value');
    const totalEl = document.getElementById('modal-total');
    const decreaseBtn = document.getElementById('qty-decrease') as HTMLButtonElement;
    const increaseBtn = document.getElementById('qty-increase') as HTMLButtonElement;

    if (tierNameEl) tierNameEl.textContent = pendingCheckout.tierName;
    if (tierPriceEl) tierPriceEl.textContent = `${formatCurrency(pendingCheckout.price)} each`;
    if (qtyValueEl) qtyValueEl.textContent = String(pendingCheckout.quantity);
    if (totalEl) totalEl.textContent = formatCurrency(pendingCheckout.price * pendingCheckout.quantity);

    if (decreaseBtn) decreaseBtn.disabled = pendingCheckout.quantity <= 1;
    if (increaseBtn) increaseBtn.disabled = pendingCheckout.quantity >= pendingCheckout.maxQuantity;
  }

  function openModal(eventId: string, tierId: string, tierName: string, price: number, available: number | null) {
    const modal = getModal();
    const checkbox = getCheckbox();
    const proceedBtn = getProceedBtn();

    if (!modal || !checkbox || !proceedBtn) return;

    // Max 10 tickets per purchase, or available stock if lower
    const maxQuantity = available !== null ? Math.min(10, available) : 10;

    pendingCheckout = {
      eventId,
      tierId,
      tierName,
      price,
      maxQuantity,
      quantity: 1,
    };

    checkbox.checked = false;
    proceedBtn.disabled = true;
    updateModalDisplay();
    modal.setAttribute('aria-hidden', 'false');
    document.body.style.overflow = 'hidden';
  }

  function closeModal() {
    const modal = getModal();
    const checkbox = getCheckbox();

    if (!modal) return;

    modal.setAttribute('aria-hidden', 'true');
    document.body.style.overflow = '';
    pendingCheckout = null;
    if (checkbox) checkbox.checked = false;
  }

  function changeQuantity(delta: number) {
    if (!pendingCheckout) return;

    const newQty = pendingCheckout.quantity + delta;
    if (newQty >= 1 && newQty <= pendingCheckout.maxQuantity) {
      pendingCheckout.quantity = newQty;
      updateModalDisplay();
    }
  }

  async function proceedToCheckout() {
    if (!pendingCheckout) return;

    const proceedBtn = getProceedBtn();
    if (!proceedBtn) return;

    const originalText = proceedBtn.textContent;
    proceedBtn.disabled = true;
    proceedBtn.textContent = 'Loading...';

    try {
      const response = await fetch('/api/checkout', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          event_id: pendingCheckout.eventId,
          ticket_tier_id: pendingCheckout.tierId,
          quantity: pendingCheckout.quantity,
        }),
      });

      const data = await response.json();

      if (data.url) {
        window.location.href = data.url;
      } else {
        throw new Error(data.error || 'Checkout failed');
      }
    } catch (err) {
      console.error('Checkout error:', err);
      proceedBtn.disabled = false;
      proceedBtn.textContent = originalText;
      alert('Something went wrong. Please try again.');
    }
  }

  function handleBuyClick(e: Event) {
    const target = e.target as HTMLElement;
    const button = target.closest('.buy-btn') as HTMLButtonElement;
    if (!button) return;

    // Prevent link navigation when button is inside an anchor
    e.preventDefault();
    e.stopPropagation();

    const eventId = button.dataset.eventId;
    const tierId = button.dataset.tierId;
    const tierName = button.dataset.tierName || 'Ticket';
    const price = parseFloat(button.dataset.price || '0');
    const available = button.dataset.available ? parseInt(button.dataset.available, 10) : null;

    if (eventId && tierId) {
      openModal(eventId, tierId, tierName, price, available);
    }
  }

  function handleModalClick(e: Event) {
    const target = e.target as HTMLElement;

    // Close on backdrop click
    if (target.classList.contains('modal-backdrop')) {
      closeModal();
      return;
    }

    // Close on cancel button
    if (target.hasAttribute('data-close-modal')) {
      closeModal();
      return;
    }

    // Quantity controls
    if (target.id === 'qty-decrease') {
      changeQuantity(-1);
      return;
    }

    if (target.id === 'qty-increase') {
      changeQuantity(1);
      return;
    }

    // Proceed to checkout
    if (target.id === 'proceed-checkout' && !target.hasAttribute('disabled')) {
      proceedToCheckout();
      return;
    }
  }

  function handleCheckboxChange(e: Event) {
    const checkbox = e.target as HTMLInputElement;
    if (checkbox.id !== 'rules-agreement') return;

    const proceedBtn = getProceedBtn();
    if (proceedBtn) {
      proceedBtn.disabled = !checkbox.checked;
    }
  }

  function handleKeydown(e: KeyboardEvent) {
    if (e.key === 'Escape') {
      const modal = getModal();
      if (modal?.getAttribute('aria-hidden') === 'false') {
        closeModal();
      }
    }
  }

  // Only add listeners once using a flag on document
  if (!(document as any).__houseRulesModalListenerAdded) {
    document.addEventListener('click', handleBuyClick);
    document.addEventListener('click', handleModalClick);
    document.addEventListener('change', handleCheckboxChange);
    document.addEventListener('keydown', handleKeydown);
    (document as any).__houseRulesModalListenerAdded = true;
  }
</script>
