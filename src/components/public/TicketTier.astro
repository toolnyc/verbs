---
import type { TicketTier } from '../../lib/supabase';

interface Props {
  tier: TicketTier;
  eventId: string;
}

const { tier, eventId } = Astro.props;

const available = tier.max_stock !== null ? tier.max_stock - tier.sold_count : null;
const isSoldOut = available !== null && available <= 0;
const isLowStock = available !== null && available > 0 && available <= 10;
const isDoorOnly = tier.tier_type === 'door';

const formattedPrice = new Intl.NumberFormat('en-US', {
  style: 'currency',
  currency: 'USD',
}).format(tier.price);
---

<div class="tier" class:list={{ 'sold-out': isSoldOut }}>
  <div class="tier-info">
    <span class="tier-name">{tier.name}</span>
    {isLowStock && !isSoldOut && (
      <span class="low-stock">Only {available} left!</span>
    )}
  </div>

  {isDoorOnly ? (
    <span class="door-price">At door {formattedPrice}</span>
  ) : isSoldOut ? (
    <span class="badge badge-sold-out">Sold out</span>
  ) : (
    <button
      class="buy-btn"
      data-event-id={eventId}
      data-tier-id={tier.id}
      data-tier-name={tier.name}
      data-price={tier.price}
    >
      Buy {formattedPrice}
    </button>
  )}
</div>

<style>
  .tier {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-md);
    border: 1px solid var(--color-fg);
    gap: var(--space-md);
  }

  .tier.sold-out {
    opacity: 0.5;
  }

  .tier-info {
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
  }

  .tier-name {
    font-weight: 500;
  }

  .low-stock {
    font-size: var(--text-xs);
    color: var(--color-error);
  }

  .door-price {
    font-size: var(--text-sm);
    color: var(--color-muted);
  }

  .buy-btn {
    padding: var(--space-sm) var(--space-lg);
    white-space: nowrap;
    background: var(--color-bg);
    border-color: var(--color--border);
    color: var(--color-fg);
  }

  .buy-btn:hover {
    background: var(--color-green);
    color: var(--color-fg);
  }
</style>

<script>
  // Store pending checkout details
  let pendingCheckout: { eventId: string; tierId: string } | null = null;

  function getModal() {
    return document.getElementById('house-rules-modal');
  }

  function getCheckbox() {
    return document.getElementById('rules-agreement') as HTMLInputElement | null;
  }

  function getProceedBtn() {
    return document.getElementById('proceed-checkout') as HTMLButtonElement | null;
  }

  function openModal(eventId: string, tierId: string) {
    const modal = getModal();
    const checkbox = getCheckbox();
    const proceedBtn = getProceedBtn();

    if (!modal || !checkbox || !proceedBtn) return;

    pendingCheckout = { eventId, tierId };
    checkbox.checked = false;
    proceedBtn.disabled = true;
    modal.setAttribute('aria-hidden', 'false');
    document.body.style.overflow = 'hidden';
  }

  function closeModal() {
    const modal = getModal();
    const checkbox = getCheckbox();

    if (!modal) return;

    modal.setAttribute('aria-hidden', 'true');
    document.body.style.overflow = '';
    pendingCheckout = null;
    if (checkbox) checkbox.checked = false;
  }

  async function proceedToCheckout() {
    if (!pendingCheckout) return;

    const proceedBtn = getProceedBtn();
    if (!proceedBtn) return;

    const originalText = proceedBtn.textContent;
    proceedBtn.disabled = true;
    proceedBtn.textContent = 'Loading...';

    try {
      const response = await fetch('/api/checkout', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          event_id: pendingCheckout.eventId,
          ticket_tier_id: pendingCheckout.tierId,
          quantity: 1,
        }),
      });

      const data = await response.json();

      if (data.url) {
        window.location.href = data.url;
      } else {
        throw new Error(data.error || 'Checkout failed');
      }
    } catch (err) {
      console.error('Checkout error:', err);
      proceedBtn.disabled = false;
      proceedBtn.textContent = originalText;
      alert('Something went wrong. Please try again.');
    }
  }

  function handleBuyClick(e: Event) {
    const target = e.target as HTMLElement;
    const button = target.closest('.buy-btn') as HTMLButtonElement;
    if (!button) return;

    const eventId = button.dataset.eventId;
    const tierId = button.dataset.tierId;

    if (eventId && tierId) {
      openModal(eventId, tierId);
    }
  }

  function handleModalClick(e: Event) {
    const target = e.target as HTMLElement;

    // Close on backdrop click
    if (target.classList.contains('modal-backdrop')) {
      closeModal();
      return;
    }

    // Close on cancel button
    if (target.hasAttribute('data-close-modal')) {
      closeModal();
      return;
    }

    // Proceed to checkout
    if (target.id === 'proceed-checkout' && !target.hasAttribute('disabled')) {
      proceedToCheckout();
      return;
    }
  }

  function handleCheckboxChange(e: Event) {
    const checkbox = e.target as HTMLInputElement;
    if (checkbox.id !== 'rules-agreement') return;

    const proceedBtn = getProceedBtn();
    if (proceedBtn) {
      proceedBtn.disabled = !checkbox.checked;
    }
  }

  function handleKeydown(e: KeyboardEvent) {
    if (e.key === 'Escape') {
      const modal = getModal();
      if (modal?.getAttribute('aria-hidden') === 'false') {
        closeModal();
      }
    }
  }

  // Only add listeners once using a flag on document
  if (!(document as any).__ticketBuyListenerAdded) {
    document.addEventListener('click', handleBuyClick);
    document.addEventListener('click', handleModalClick);
    document.addEventListener('change', handleCheckboxChange);
    document.addEventListener('keydown', handleKeydown);
    (document as any).__ticketBuyListenerAdded = true;
  }
</script>
