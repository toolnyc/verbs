---
import type { TicketTier } from '../../lib/supabase';

interface Props {
  tier: TicketTier;
  eventId: string;
}

const { tier, eventId } = Astro.props;

const available = tier.max_stock !== null ? tier.max_stock - tier.sold_count : null;
const isSoldOut = available !== null && available <= 0;
const isLowStock = available !== null && available > 0 && available <= 10;
const isDoorOnly = tier.tier_type === 'door';

const formattedPrice = new Intl.NumberFormat('en-US', {
  style: 'currency',
  currency: 'USD',
}).format(tier.price);
---

<div class="tier" class:list={{ 'sold-out': isSoldOut }}>
  <div class="tier-info">
    <span class="tier-name">{tier.name}</span>
    {isLowStock && !isSoldOut && (
      <span class="low-stock">Only {available} left!</span>
    )}
  </div>

  {isDoorOnly ? (
    <span class="door-price">At door {formattedPrice}</span>
  ) : isSoldOut ? (
    <span class="badge badge-sold-out">Sold out</span>
  ) : (
    <button
      class="buy-btn"
      data-event-id={eventId}
      data-tier-id={tier.id}
      data-tier-name={tier.name}
      data-price={tier.price}
      data-available={available}
    >
      Buy {formattedPrice}
    </button>
  )}
</div>

<style>
  .tier {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-md);
    border: 1px solid var(--color-fg);
    gap: var(--space-md);
  }

  .tier.sold-out {
    opacity: 0.5;
  }

  .tier-info {
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
  }

  .tier-name {
    font-weight: 500;
  }

  .low-stock {
    font-size: var(--text-xs);
    color: var(--color-error);
  }

  .door-price {
    font-size: var(--text-sm);
    color: var(--color-muted);
  }

  .buy-btn {
    padding: var(--space-sm) var(--space-lg);
    white-space: nowrap;
    background: var(--color-bg);
    border-color: var(--color--border);
    color: var(--color-fg);
  }

  .buy-btn:hover {
    background: var(--color-green);
    color: var(--color-fg);
  }

  @media (max-width: 480px) {
    .tier {
      flex-direction: column;
      align-items: stretch;
      gap: var(--space-sm);
    }

    .tier-info {
      flex-direction: row;
      justify-content: space-between;
      align-items: center;
    }

    .buy-btn {
      width: 100%;
      text-align: center;
    }

    .door-price {
      text-align: center;
    }

    .badge-sold-out {
      text-align: center;
      display: block;
    }
  }
</style>
