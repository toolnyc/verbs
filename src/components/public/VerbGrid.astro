---
import type { Event } from '../../lib/supabase';

interface Props {
  events: Event[];
  isAuthenticated?: boolean;
  featuredEventId?: string | null;
}

const { events, isAuthenticated = false, featuredEventId = null } = Astro.props;
---

<div class="verb-grid">
  {events.map(event => {
    const isPublished = event.status === 'published';
    const isDraft = event.status === 'draft';
    const isFeatured = event.id === featuredEventId;
    // Published events are always clickable; drafts only when authenticated
    const isClickable = isPublished || (isDraft && isAuthenticated);

    return isClickable ? (
      <a href={`/events/${event.id}`} class={`verb-item clickable ${isDraft ? 'draft' : ''} ${isFeatured ? 'featured' : ''}`}>
        <div class="hover-bg"></div>
        <span class="verb-title">{event.title}</span>
        {isDraft && <span class="draft-badge">Draft</span>}
        {event.image_url && (
          <div class="flyer-preview">
            <img src={event.image_url} alt={event.title} />
          </div>
        )}
      </a>
    ) : (
      <div class={`verb-item future ${isFeatured ? 'featured' : ''}`}>
        <span class="verb-title">{event.title}</span>
        {event.image_url && (
          <div class="flyer-preview">
            <img src={event.image_url} alt={event.title} />
          </div>
        )}
      </div>
    );
  })}
</div>

<style>
  .verb-item.draft {
    position: relative;
  }

  .verb-item.clickable {
    position: relative;
    overflow: hidden;
  }

  .hover-bg {
    position: absolute;
    inset: 0;
    background: var(--color-fg);
    transform: translateY(100%);
    z-index: 0;
    pointer-events: none;
  }

  .verb-item .verb-title {
    position: relative;
    z-index: 1;
  }

  .draft-badge {
    position: absolute;
    top: var(--space-sm);
    right: var(--space-sm);
    font-size: var(--text-xs);
    text-transform: uppercase;
    padding: var(--space-xs) var(--space-sm);
    background: var(--color-bg);
    border: 1px solid var(--color-fg);
    opacity: 0.8;
    z-index: 2;
  }
</style>

<script>
  import gsap from 'gsap';
  import { createHoverPreview } from '../../lib/animations';

  // Initialize hover previews and animated backgrounds for verb items
  const verbItems = document.querySelectorAll('.verb-item');

  verbItems.forEach(item => {
    const preview = item.querySelector('.flyer-preview') as HTMLElement;
    if (preview) {
      createHoverPreview(item as HTMLElement, preview);
    }

    // Only add hover animation to clickable items
    if (!item.classList.contains('clickable')) return;

    const hoverBg = item.querySelector('.hover-bg') as HTMLElement;
    const title = item.querySelector('.verb-title') as HTMLElement;
    if (!hoverBg || !title) return;

    // GSAP hover animation
    const tl = gsap.timeline({ paused: true });

    // Animate background sliding up with a slight skew for diagonal effect
    tl.to(hoverBg, {
      y: 0,
      skewY: -2,
      duration: 0.4,
      ease: 'power3.out',
    })
    .to(hoverBg, {
      skewY: 0,
      duration: 0.2,
      ease: 'power2.out',
    }, '-=0.1')
    .to(title, {
      color: 'var(--color-bg)',
      duration: 0.3,
      ease: 'power2.out',
    }, 0.1);

    item.addEventListener('mouseenter', () => {
      tl.play();
    });

    item.addEventListener('mouseleave', () => {
      tl.reverse();
    });
  });
</script>
