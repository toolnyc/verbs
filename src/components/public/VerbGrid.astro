---
import type { Event } from '../../lib/supabase';

interface Props {
  events: Event[];
  isAuthenticated?: boolean;
  featuredEventId?: string | null;
}

const { events, isAuthenticated = false, featuredEventId = null } = Astro.props;
---

<div class="verb-grid">
  {events.map(event => {
    const isPublished = event.status === 'published';
    const isDraft = event.status === 'draft';
    const isFeatured = event.id === featuredEventId;
    // Published events are always clickable; drafts only when authenticated
    const isClickable = isPublished || (isDraft && isAuthenticated);

    return isClickable ? (
      <a href={`/events/${event.id}`} class={`verb-item clickable ${isDraft ? 'draft' : ''} ${isFeatured ? 'featured' : ''}`}>
        <div class="hover-bg"></div>
        <span class="verb-title">{event.title}</span>
        {isDraft && <span class="draft-badge">Draft</span>}
        {(event.flyer_url || event.image_url) && (
          <div class="flyer-preview">
            <img src={event.flyer_url || event.image_url} alt={event.title} />
          </div>
        )}
      </a>
    ) : (
      <div class={`verb-item future ${isFeatured ? 'featured' : ''}`}>
        <span class="verb-title">{event.title}</span>
        {(event.flyer_url || event.image_url) && (
          <div class="flyer-preview">
            <img src={event.flyer_url || event.image_url} alt={event.title} />
          </div>
        )}
      </div>
    );
  })}
</div>

<style>
  .verb-item.draft {
    position: relative;
  }

  .verb-item.clickable {
    position: relative;
    overflow: hidden;
  }

  .hover-bg {
    position: absolute;
    inset: 0;
    background: var(--color-fg);
    transform: translateY(100%);
    z-index: 0;
    pointer-events: none;
  }

  .verb-item .verb-title {
    position: relative;
    z-index: 1;
  }

  .draft-badge {
    position: absolute;
    top: var(--space-sm);
    right: var(--space-sm);
    font-size: var(--text-xs);
    padding: var(--space-xs) var(--space-sm);
    background: var(--color-bg);
    border: 1px solid var(--color-fg);
    opacity: 0.8;
    z-index: 2;
  }
</style>

<script>
  import gsap from 'gsap';
  import { createHoverPreview } from '../../lib/animations';

  // Store cleanup functions for re-initialization
  const cleanupFunctions: (() => void)[] = [];

  function initVerbGridAnimations() {
    // Clean up previous animations
    cleanupFunctions.forEach(cleanup => cleanup());
    cleanupFunctions.length = 0;

    // Initialize hover previews and animated backgrounds for verb items
    const verbItems = document.querySelectorAll('.verb-item');

    verbItems.forEach(item => {
      const preview = item.querySelector('.flyer-preview') as HTMLElement;
      if (preview) {
        const cleanup = createHoverPreview(item as HTMLElement, preview);
        cleanupFunctions.push(cleanup);
      }

      // Only add hover animation to clickable items
      if (!item.classList.contains('clickable')) return;

      const hoverBg = item.querySelector('.hover-bg') as HTMLElement;
      const title = item.querySelector('.verb-title') as HTMLElement;
      if (!hoverBg || !title) return;

      // Reset any existing transforms
      gsap.set(hoverBg, { y: '100%', skewY: 0 });
      gsap.set(title, { clearProps: 'color' });

      // GSAP hover animation
      const tl = gsap.timeline({ paused: true });

      // Animate background sliding up with a slight skew for diagonal effect
      tl.to(hoverBg, {
        y: 0,
        skewY: -2,
        duration: 0.4,
        ease: 'power3.out',
      })
      .to(hoverBg, {
        skewY: 0,
        duration: 0.2,
        ease: 'power2.out',
      }, '-=0.1')
      .to(title, {
        color: 'var(--color-bg)',
        duration: 0.3,
        ease: 'power2.out',
      }, 0.1);

      const onEnter = () => tl.play();
      const onLeave = () => tl.reverse();

      item.addEventListener('mouseenter', onEnter);
      item.addEventListener('mouseleave', onLeave);

      // Store cleanup function
      cleanupFunctions.push(() => {
        tl.kill();
        item.removeEventListener('mouseenter', onEnter);
        item.removeEventListener('mouseleave', onLeave);
      });
    });
  }

  // Initialize on first load
  initVerbGridAnimations();

  // Re-initialize after Astro view transitions
  document.addEventListener('astro:page-load', initVerbGridAnimations);
</script>
