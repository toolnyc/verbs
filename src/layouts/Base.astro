---
import { Font } from 'astro:assets';
import { ViewTransitions } from 'astro:transitions';
import '../styles/global.css';
// MVP: Mix functionality gated - uncomment to re-enable
// import PersistentPlayer from '../components/public/PersistentPlayer.astro';
// import { getPublishedMixes } from '../lib/supabase';

interface Props {
  title?: string;
  description?: string;
}

const {
  title = 'VERBS',
  description = 'Events from VERBS collective'
} = Astro.props;

const siteUrl = import.meta.env.PUBLIC_SITE_URL || 'https://www.verbsaroundthe.world/';

// MVP: Mix functionality gated - uncomment to re-enable
// const mixes = await getPublishedMixes();
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content="website" />
    <meta property="og:url" content={siteUrl} />
    <Font cssVariable="--font-sans" preload />
    <ViewTransitions />
    <title>{title}</title>
  </head>
  <body>
    <!-- Page transition overlay -->
    <div class="page-transition" id="page-transition" aria-hidden="true"></div>

    <!-- Retro camera lens blur effect -->
    <div class="lens-blur" aria-hidden="true"></div>
    <!-- Canvas noise overlay -->
    <canvas id="noise-canvas" class="noise-overlay" aria-hidden="true"></canvas>

    <!-- MVP: Mix functionality gated - uncomment to re-enable -->
    <!-- <PersistentPlayer mixes={mixes} /> -->
    <slot />
  </body>
</html>

<style is:global>
  /* Page transition overlay - GPU accelerated */
  .page-transition {
    position: fixed;
    inset: 0;
    z-index: 10000;
    background: var(--color-cream);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    will-change: opacity;
  }

  .page-transition.active {
    opacity: 1;
    pointer-events: all;
  }

  /* Canvas noise texture overlay */
  .noise-overlay {
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 9999;
    opacity: 0;
    transition: opacity 0.3s ease-in;
  }

  .noise-overlay.ready {
    opacity: 0.05;
  }

  /* Subtle camera lens blur overlay */
  .lens-blur {
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 9998;
    backdrop-filter: blur(0.44px);
    -webkit-backdrop-filter: blur(0.44px);
  }

  /* Disable effects on reduced motion preference */
  @media (prefers-reduced-motion: reduce) {
    .noise-overlay,
    .lens-blur {
      display: none;
    }
    .page-transition {
      transition: none;
    }
  }
</style>

<script>
  declare global {
    interface Window {
      _noiseInterval?: number;
    }
  }

  // Page transition handling with Astro ViewTransitions
  let transitionStartTime = 0;
  const MIN_TRANSITION_TIME = 500; // 0.5s minimum total transition

  function initPageTransitions() {
    // Show overlay when navigation starts
    document.addEventListener('astro:before-preparation', (e: any) => {
      transitionStartTime = performance.now();
      const transitionOverlay = document.getElementById('page-transition');
      if (transitionOverlay) {
        transitionOverlay.classList.add('active');
      }

      // Ensure minimum transition time before page swap
      const originalLoader = e.loader;
      e.loader = async () => {
        const [result] = await Promise.all([
          originalLoader(),
          new Promise(resolve => setTimeout(resolve, MIN_TRANSITION_TIME / 2))
        ]);
        return result;
      };
    });

    // Hide overlay after page loads
    document.addEventListener('astro:page-load', () => {
      const overlay = document.getElementById('page-transition');
      if (overlay && overlay.classList.contains('active')) {
        const elapsed = performance.now() - transitionStartTime;
        const remaining = Math.max(0, MIN_TRANSITION_TIME - elapsed);

        setTimeout(() => {
          overlay.classList.remove('active');
        }, remaining);
      }
    });
  }

  initPageTransitions();

  function initNoise() {
    const canvas = document.getElementById('noise-canvas') as HTMLCanvasElement;
    if (!canvas) return;

    // Clear any existing interval
    if (window._noiseInterval) {
      clearInterval(window._noiseInterval);
    }

    // Remove ready class to reset state
    canvas.classList.remove('ready');

    const ctx = canvas.getContext('2d');
    if (!ctx) return;

    // Set canvas size to viewport
    function resize() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    resize();
    window.addEventListener('resize', resize);

    // Generate noise frame
    function generateNoise() {
      const imageData = ctx.createImageData(canvas.width, canvas.height);
      const data = imageData.data;

      for (let i = 0; i < data.length; i += 4) {
        const value = Math.random() * 255;
        data[i] = value;     // R
        data[i + 1] = value; // G
        data[i + 2] = value; // B
        data[i + 3] = 255;   // A
      }

      ctx.putImageData(imageData, 0, 0);
    }

    // Use setInterval instead of rAF to prevent pausing on click
    generateNoise();
    window._noiseInterval = window.setInterval(generateNoise, 50); // ~20fps

    // Fade in after page content is ready
    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        canvas.classList.add('ready');
      });
    });

    // Cleanup on page transition
    document.addEventListener('astro:before-preparation', () => {
      if (window._noiseInterval) {
        clearInterval(window._noiseInterval);
      }
    }, { once: true });
  }

  // Initialize on load
  initNoise();

  // Re-initialize after Astro view transitions
  document.addEventListener('astro:page-load', initNoise);
</script>

