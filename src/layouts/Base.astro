---
import { Font } from 'astro:assets';
import { ViewTransitions } from 'astro:transitions';
import '../styles/global.css';
// MVP: Mix functionality gated - uncomment to re-enable
// import PersistentPlayer from '../components/public/PersistentPlayer.astro';
// import { getPublishedMixes } from '../lib/supabase';

interface Props {
  title?: string;
  description?: string;
}

const {
  title = 'VERBS',
  description = 'Events from VERBS collective'
} = Astro.props;

const siteUrl = import.meta.env.PUBLIC_SITE_URL || 'https://www.verbsaroundthe.world/';

// MVP: Mix functionality gated - uncomment to re-enable
// const mixes = await getPublishedMixes();
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content="website" />
    <meta property="og:url" content={siteUrl} />
    <Font cssVariable="--font-sans" preload />
    <ViewTransitions />
    <title>{title}</title>
  </head>
  <body>
    <!-- Retro camera lens blur effect -->
    <div class="lens-blur" aria-hidden="true"></div>
    <!-- Canvas noise overlay -->
    <canvas id="noise-canvas" class="noise-overlay" aria-hidden="true"></canvas>

    <!-- MVP: Mix functionality gated - uncomment to re-enable -->
    <!-- <PersistentPlayer mixes={mixes} /> -->
    <slot />
  </body>
</html>

<style is:global>
  /* Canvas noise texture overlay */
  .noise-overlay {
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 9999;
    opacity: 0;
    transition: opacity 0.3s ease-in;
  }

  .noise-overlay.ready {
    opacity: 0.08;
  }

  /* Subtle camera lens blur overlay */
  .lens-blur {
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 9998;
    backdrop-filter: blur(0.4px);
    -webkit-backdrop-filter: blur(0.4px);
  }

  /* Disable effects on reduced motion preference */
  @media (prefers-reduced-motion: reduce) {
    .noise-overlay,
    .lens-blur {
      display: none;
    }
  }
</style>

<script>
  declare global {
    interface Window {
      _noiseInterval?: number;
    }
  }

  function initNoise() {
    const canvas = document.getElementById('noise-canvas') as HTMLCanvasElement;
    if (!canvas) return;

    // Clear any existing interval
    if (window._noiseInterval) {
      clearInterval(window._noiseInterval);
    }

    // Remove ready class to reset state
    canvas.classList.remove('ready');

    const ctx = canvas.getContext('2d');
    if (!ctx) return;

    // Scale factor for finer grain (higher = smaller grain)
    const scale = 3;

    // Set canvas size to viewport (scaled up for finer grain)
    function resize() {
      canvas.width = window.innerWidth * scale;
      canvas.height = window.innerHeight * scale;
      // CSS keeps it at viewport size, so grain appears smaller
      canvas.style.width = window.innerWidth + 'px';
      canvas.style.height = window.innerHeight + 'px';
    }
    resize();
    window.addEventListener('resize', resize);

    // Generate noise frame
    function generateNoise() {
      const imageData = ctx.createImageData(canvas.width, canvas.height);
      const data = imageData.data;

      for (let i = 0; i < data.length; i += 4) {
        const value = Math.random() * 255;
        data[i] = value;     // R
        data[i + 1] = value; // G
        data[i + 2] = value; // B
        data[i + 3] = 255;   // A
      }

      ctx.putImageData(imageData, 0, 0);
    }

    // Use setInterval instead of rAF to prevent pausing on click
    generateNoise();
    window._noiseInterval = window.setInterval(generateNoise, 50); // ~20fps

    // Fade in after page content is ready
    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        canvas.classList.add('ready');
      });
    });

    // Cleanup on page transition
    document.addEventListener('astro:before-preparation', () => {
      if (window._noiseInterval) {
        clearInterval(window._noiseInterval);
      }
    }, { once: true });
  }

  // Initialize on load
  initNoise();

  // Re-initialize after Astro view transitions
  document.addEventListener('astro:page-load', initNoise);
</script>

