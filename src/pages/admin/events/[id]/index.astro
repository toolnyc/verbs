---
import Admin from '../../../../layouts/Admin.astro';
import FileUpload from '../../../../components/admin/FileUpload.astro';
import { supabaseAdmin } from '../../../../lib/supabase';
import { createProductAndPrice, updatePrice } from '../../../../lib/stripe';

const { id } = Astro.params;

let event: any = null;
let tiers: any[] = [];
let eventDjs: any[] = [];
let allDjs: any[] = [];
let error = '';
let success = '';

if (supabaseAdmin && id) {
  // Fetch event
  const { data: eventData } = await supabaseAdmin
    .from('events')
    .select('*')
    .eq('id', id)
    .single();

  event = eventData;

  // Fetch tiers
  const { data: tiersData } = await supabaseAdmin
    .from('ticket_tiers')
    .select('*')
    .eq('event_id', id)
    .order('sort_order');

  tiers = tiersData || [];

  // Fetch event DJs
  const { data: djsData } = await supabaseAdmin
    .from('event_djs')
    .select('*, dj:djs(*)')
    .eq('event_id', id)
    .order('sort_order');

  eventDjs = djsData || [];

  // Fetch all DJs for selector
  const { data: allDjsData } = await supabaseAdmin
    .from('djs')
    .select('*')
    .order('name');

  allDjs = allDjsData || [];
}

// Handle form submissions
if (Astro.request.method === 'POST' && supabaseAdmin && event) {
  const formData = await Astro.request.formData();
  const action = formData.get('action');

  if (action === 'update_event') {
    const { error: updateError } = await supabaseAdmin
      .from('events')
      .update({
        title: formData.get('title'),
        description: formData.get('description') || null,
        date: formData.get('date'),
        time_end: formData.get('time_end') || null,
        timezone: formData.get('timezone') || 'America/New_York',
        venue_name: formData.get('venue_name'),
        venue_city: formData.get('venue_city'),
        venue_link: formData.get('venue_link') || null,
        image_url: formData.get('flyer_url') || null,
        flyer_url: formData.get('flyer_url') || null,
        hover_color: formData.get('hover_color') || null,
        status: formData.get('status'),
        updated_at: new Date().toISOString(),
      })
      .eq('id', id);

    if (updateError) {
      error = updateError.message;
    } else {
      success = 'Event updated';
      // Refresh event data
      const { data: refreshed } = await supabaseAdmin.from('events').select('*').eq('id', id).single();
      event = refreshed;
    }
  }

  if (action === 'add_tier') {
    const tierData: any = {
      event_id: id,
      name: formData.get('tier_name'),
      tier_type: formData.get('tier_type'),
      price: parseFloat(formData.get('tier_price') as string),
      max_stock: formData.get('tier_max_stock') ? parseInt(formData.get('tier_max_stock') as string) : null,
      is_active: true,
      sort_order: tiers.length,
    };

    // Create Stripe product and price for online tiers
    if (tierData.tier_type === 'online') {
      try {
        const { productId, priceId } = await createProductAndPrice({
          eventTitle: event.title,
          tierName: tierData.name,
          price: tierData.price,
        });
        tierData.stripe_product_id = productId;
        tierData.stripe_price_id = priceId;
      } catch (stripeErr: any) {
        error = `Stripe error: ${stripeErr.message}`;
      }
    }

    if (!error) {
      const { error: tierError } = await supabaseAdmin.from('ticket_tiers').insert(tierData);
      if (tierError) {
        error = tierError.message;
      } else {
        success = 'Ticket tier added';
      }
    }

    // Refresh tiers
    const { data: refreshedTiers } = await supabaseAdmin
      .from('ticket_tiers').select('*').eq('event_id', id).order('sort_order');
    tiers = refreshedTiers || [];
  }

  if (action === 'delete_tier') {
    const tierId = formData.get('tier_id');
    await supabaseAdmin.from('ticket_tiers').delete().eq('id', tierId);
    success = 'Tier deleted';

    const { data: refreshedTiers } = await supabaseAdmin
      .from('ticket_tiers').select('*').eq('event_id', id).order('sort_order');
    tiers = refreshedTiers || [];
  }

  if (action === 'toggle_tier') {
    const tierId = formData.get('tier_id');
    const isActive = formData.get('is_active') === 'true';
    await supabaseAdmin.from('ticket_tiers').update({ is_active: !isActive }).eq('id', tierId);

    const { data: refreshedTiers } = await supabaseAdmin
      .from('ticket_tiers').select('*').eq('event_id', id).order('sort_order');
    tiers = refreshedTiers || [];
  }

  if (action === 'sync_tier_stripe') {
    const tierId = formData.get('tier_id');

    // Fetch the tier
    const { data: tier } = await supabaseAdmin
      .from('ticket_tiers')
      .select('*')
      .eq('id', tierId)
      .single();

    if (tier && tier.tier_type === 'online' && !tier.stripe_price_id) {
      try {
        const { productId, priceId } = await createProductAndPrice({
          eventTitle: event.title,
          tierName: tier.name,
          price: tier.price,
        });

        await supabaseAdmin
          .from('ticket_tiers')
          .update({
            stripe_product_id: productId,
            stripe_price_id: priceId,
          })
          .eq('id', tierId);

        success = 'Stripe product created successfully';
      } catch (stripeErr: any) {
        error = `Stripe error: ${stripeErr.message}`;
      }
    }

    const { data: refreshedTiers } = await supabaseAdmin
      .from('ticket_tiers').select('*').eq('event_id', id).order('sort_order');
    tiers = refreshedTiers || [];
  }

  if (action === 'add_dj') {
    const djId = formData.get('dj_id');
    const newDjName = formData.get('new_dj_name');
    const slotStart = formData.get('slot_start') as string || null;
    const slotEnd = formData.get('slot_end') as string || null;

    let targetDjId = djId;

    // Create new DJ if specified
    if (newDjName) {
      const { data: newDj } = await supabaseAdmin
        .from('djs')
        .insert({ name: newDjName })
        .select()
        .single();

      if (newDj) {
        targetDjId = newDj.id;
      }
    }

    if (targetDjId) {
      await supabaseAdmin.from('event_djs').insert({
        event_id: id,
        dj_id: targetDjId,
        slot_start: slotStart || null,
        slot_end: slotEnd || null,
        sort_order: eventDjs.length,
      });

      // Refresh
      const { data: refreshedDjs } = await supabaseAdmin
        .from('event_djs').select('*, dj:djs(*)').eq('event_id', id).order('sort_order');
      eventDjs = refreshedDjs || [];

      const { data: refreshedAllDjs } = await supabaseAdmin.from('djs').select('*').order('name');
      allDjs = refreshedAllDjs || [];
    }
  }

  if (action === 'update_dj_times') {
    const eventDjId = formData.get('event_dj_id');
    const slotStart = formData.get('slot_start') as string || null;
    const slotEnd = formData.get('slot_end') as string || null;

    await supabaseAdmin
      .from('event_djs')
      .update({
        slot_start: slotStart || null,
        slot_end: slotEnd || null,
      })
      .eq('id', eventDjId);

    // Refresh
    const { data: refreshedDjs } = await supabaseAdmin
      .from('event_djs').select('*, dj:djs(*)').eq('event_id', id).order('sort_order');
    eventDjs = refreshedDjs || [];
  }

  if (action === 'remove_dj') {
    const eventDjId = formData.get('event_dj_id');
    await supabaseAdmin.from('event_djs').delete().eq('id', eventDjId);

    const { data: refreshedDjs } = await supabaseAdmin
      .from('event_djs').select('*, dj:djs(*)').eq('event_id', id).order('sort_order');
    eventDjs = refreshedDjs || [];
  }
}

if (!event) {
  return Astro.redirect('/admin/events');
}

function formatDateForInput(date: string) {
  return new Date(date).toISOString().slice(0, 16);
}

const assignedDjIds = new Set(eventDjs.map(ed => ed.dj_id));
const availableDjs = allDjs.filter(dj => !assignedDjIds.has(dj.id));
---

<Admin title={`Edit: ${event.title}`}>
  {error && <p class="error-message mb-lg">{error}</p>}
  {success && <p class="success-message mb-lg">{success}</p>}

  <div class="edit-grid">
    <div class="edit-main">
      <form method="POST" class="admin-form">
        <input type="hidden" name="action" value="update_event" />

        <div class="form-group">
          <label for="title" class="form-label">Event Title *</label>
          <input type="text" id="title" name="title" value={event.title} required />
        </div>

        <div class="form-group">
          <label for="description" class="form-label">Description</label>
          <textarea id="description" name="description" rows="4">{event.description}</textarea>
        </div>

        <div class="form-group">
          <FileUpload
            name="flyer_url"
            type="image"
            currentUrl={event.flyer_url}
            label="Event Flyer"
          />
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="date" class="form-label">Start Date & Time *</label>
            <input type="datetime-local" id="date" name="date" value={formatDateForInput(event.date)} required />
          </div>

          <div class="form-group">
            <label for="time_end" class="form-label">End Time</label>
            <input type="datetime-local" id="time_end" name="time_end" value={event.time_end ? formatDateForInput(event.time_end) : ''} />
          </div>
        </div>

        <div class="form-group">
          <label for="timezone" class="form-label">Timezone</label>
          <select id="timezone" name="timezone">
            <option value="America/New_York" selected={event.timezone === 'America/New_York'}>Eastern (America/New_York)</option>
            <option value="America/Chicago" selected={event.timezone === 'America/Chicago'}>Central (America/Chicago)</option>
            <option value="America/Denver" selected={event.timezone === 'America/Denver'}>Mountain (America/Denver)</option>
            <option value="America/Los_Angeles" selected={event.timezone === 'America/Los_Angeles'}>Pacific (America/Los_Angeles)</option>
            <option value="America/Phoenix" selected={event.timezone === 'America/Phoenix'}>Arizona (America/Phoenix)</option>
            <option value="America/Anchorage" selected={event.timezone === 'America/Anchorage'}>Alaska (America/Anchorage)</option>
            <option value="Pacific/Honolulu" selected={event.timezone === 'Pacific/Honolulu'}>Hawaii (Pacific/Honolulu)</option>
            <option value="Europe/London" selected={event.timezone === 'Europe/London'}>UK (Europe/London)</option>
            <option value="Europe/Paris" selected={event.timezone === 'Europe/Paris'}>Central Europe (Europe/Paris)</option>
            <option value="Europe/Berlin" selected={event.timezone === 'Europe/Berlin'}>Germany (Europe/Berlin)</option>
            <option value="Europe/Amsterdam" selected={event.timezone === 'Europe/Amsterdam'}>Netherlands (Europe/Amsterdam)</option>
            <option value="Asia/Tokyo" selected={event.timezone === 'Asia/Tokyo'}>Japan (Asia/Tokyo)</option>
            <option value="Asia/Shanghai" selected={event.timezone === 'Asia/Shanghai'}>China (Asia/Shanghai)</option>
            <option value="Australia/Sydney" selected={event.timezone === 'Australia/Sydney'}>Sydney (Australia/Sydney)</option>
          </select>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="venue_name" class="form-label">Venue Name *</label>
            <input type="text" id="venue_name" name="venue_name" value={event.venue_name} required />
          </div>

          <div class="form-group">
            <label for="venue_city" class="form-label">City *</label>
            <input type="text" id="venue_city" name="venue_city" value={event.venue_city} required />
          </div>
        </div>

        <div class="form-group">
          <label for="venue_link" class="form-label">Venue Link</label>
          <input type="url" id="venue_link" name="venue_link" value={event.venue_link || ''} />
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="status" class="form-label">Status</label>
            <select id="status" name="status">
              <option value="draft" selected={event.status === 'draft'}>Draft</option>
              <option value="published" selected={event.status === 'published'}>Published</option>
              <option value="archived" selected={event.status === 'archived'}>Archived</option>
            </select>
          </div>

          <div class="form-group">
            <label for="hover_color" class="form-label">Hover Color</label>
            <select id="hover_color" name="hover_color">
              <option value="" selected={!event.hover_color}>Default (Black)</option>
              <option value="#f20519" selected={event.hover_color === '#f20519'}>Red</option>
              <option value="#f2b705" selected={event.hover_color === '#f2b705'}>Yellow</option>
              <option value="#1bf59f" selected={event.hover_color === '#1bf59f'}>Green</option>
            </select>
            <p class="form-hint">Color shown on hover in the event grid</p>
          </div>
        </div>

        <div class="form-actions">
          <a href="/admin/events" class="secondary">Back to Events</a>
          <button type="submit">Save Changes</button>
        </div>
      </form>
    </div>

    <div class="edit-sidebar">
      <!-- Ticket Tiers -->
      <div class="admin-card">
        <div class="admin-card-header">
          <h2 class="admin-card-title">Ticket Tiers</h2>
        </div>

        {tiers.length > 0 && (
          <div class="tiers-list">
            {tiers.map(tier => (
              <div class:list={['tier-item', { inactive: !tier.is_active }]}>
                <div class="tier-info">
                  <span class="tier-name">{tier.name}</span>
                  <span class="tier-price">${tier.price}</span>
                  <span class="tier-type text-xs text-muted">{tier.tier_type}</span>
                </div>
                <div class="tier-stats">
                  <span class="text-sm">{tier.sold_count} / {tier.max_stock || '∞'}</span>
                </div>
                <div class="tier-actions">
                  {tier.tier_type === 'online' && !tier.stripe_price_id && (
                    <form method="POST" class="inline-form">
                      <input type="hidden" name="action" value="sync_tier_stripe" />
                      <input type="hidden" name="tier_id" value={tier.id} />
                      <button type="submit" class="btn-sm btn-warning">Sync Stripe</button>
                    </form>
                  )}
                  <form method="POST" class="inline-form">
                    <input type="hidden" name="action" value="toggle_tier" />
                    <input type="hidden" name="tier_id" value={tier.id} />
                    <input type="hidden" name="is_active" value={tier.is_active} />
                    <button type="submit" class="btn-sm secondary">
                      {tier.is_active ? 'Disable' : 'Enable'}
                    </button>
                  </form>
                  {tier.sold_count === 0 && (
                    <form method="POST" class="inline-form">
                      <input type="hidden" name="action" value="delete_tier" />
                      <input type="hidden" name="tier_id" value={tier.id} />
                      <button type="submit" class="btn-sm btn-danger">Delete</button>
                    </form>
                  )}
                </div>
              </div>
            ))}
          </div>
        )}

        <form method="POST" class="add-tier-form">
          <input type="hidden" name="action" value="add_tier" />
          <h4 class="text-sm mt-lg mb-sm">Add Tier</h4>
          <div class="tier-form-grid">
            <input type="text" name="tier_name" placeholder="Name" required />
            <input type="number" name="tier_price" placeholder="Price" step="0.01" min="0" required />
            <input type="number" name="tier_max_stock" placeholder="Stock (blank=unlimited)" min="0" />
            <select name="tier_type">
              <option value="online">Online</option>
              <option value="door">Door only</option>
            </select>
          </div>
          <button type="submit" class="btn-sm mt-sm">Add Tier</button>
        </form>
      </div>

      <!-- DJs -->
      <div class="admin-card">
        <div class="admin-card-header">
          <h2 class="admin-card-title">Lineup</h2>
        </div>

        <div class="djs-list" id="djs-list">
          {eventDjs.map(ed => (
            <div class="dj-item" data-event-dj-id={ed.id}>
              <div class="dj-info">
                <span class="dj-name">{ed.dj?.name}</span>
                <form method="POST" class="dj-times-form">
                  <input type="hidden" name="action" value="update_dj_times" />
                  <input type="hidden" name="event_dj_id" value={ed.id} />
                  <div class="time-inputs">
                    <input
                      type="time"
                      name="slot_start"
                      value={ed.slot_start || ''}
                      placeholder="Start"
                      class="time-input"
                    />
                    <span class="time-separator">—</span>
                    <input
                      type="time"
                      name="slot_end"
                      value={ed.slot_end || ''}
                      placeholder="End"
                      class="time-input"
                    />
                    <button type="submit" class="btn-sm">Save</button>
                  </div>
                </form>
              </div>
              <form method="POST" class="inline-form">
                <input type="hidden" name="action" value="remove_dj" />
                <input type="hidden" name="event_dj_id" value={ed.id} />
                <button type="submit" class="btn-sm secondary">Remove</button>
              </form>
            </div>
          ))}
        </div>

        <form class="add-dj-form" id="add-dj-form" data-event-id={id}>
          <h4 class="text-sm mt-lg mb-sm">Add DJ</h4>
          {availableDjs.length > 0 && (
            <select name="dj_id" id="dj-select" class="mb-sm">
              <option value="">Select existing DJ...</option>
              {availableDjs.map(dj => (
                <option value={dj.id}>{dj.name}</option>
              ))}
            </select>
          )}
          <input type="text" name="new_dj_name" id="new-dj-name" placeholder="Or create new DJ..." class="mb-sm" />
          <div class="time-inputs mb-sm">
            <input type="time" name="slot_start" id="slot-start" placeholder="Start time" class="time-input" />
            <span class="time-separator">—</span>
            <input type="time" name="slot_end" id="slot-end" placeholder="End time" class="time-input" />
          </div>
          <button type="submit" class="btn-sm" id="add-dj-btn">Add to Lineup</button>
          <span class="add-dj-status text-sm ml-sm" id="add-dj-status"></span>
        </form>
      </div>

      <!-- Quick Actions -->
      <div class="admin-card">
        <div class="admin-card-header">
          <h2 class="admin-card-title">Quick Actions</h2>
        </div>
        <div class="quick-actions">
          <a href={`/admin/events/${id}/orders`} class="action-link">View Orders</a>
          {event.status === 'published' && (
            <a href="/" target="_blank" class="action-link">View on Site</a>
          )}
        </div>
      </div>
    </div>
  </div>
</Admin>

<style>
  .edit-grid {
    display: grid;
    grid-template-columns: 1fr 400px;
    gap: var(--space-xl);
    align-items: start;
  }

  @media (max-width: 1024px) {
    .edit-grid {
      grid-template-columns: 1fr;
    }
  }

  .edit-sidebar {
    display: flex;
    flex-direction: column;
    gap: var(--space-lg);
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-lg);
  }

  @media (max-width: 640px) {
    .form-row {
      grid-template-columns: 1fr;
    }
  }

  .error-message {
    background: #fce8e6;
    color: #c5221f;
    padding: var(--space-md);
  }

  .success-message {
    background: #e6f4ea;
    color: #137333;
    padding: var(--space-md);
  }

  .tiers-list,
  .djs-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
  }

  .tier-item {
    display: grid;
    grid-template-columns: 1fr auto auto;
    gap: var(--space-sm);
    align-items: center;
    padding: var(--space-sm);
    background: var(--color-bg-alt);
  }

  .tier-item.inactive {
    opacity: 0.5;
  }

  .tier-info {
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
  }

  .tier-name {
    font-weight: 500;
  }

  .tier-actions {
    display: flex;
    gap: var(--space-xs);
  }

  .dj-item {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding: var(--space-sm);
    background: var(--color-bg-alt);
    gap: var(--space-sm);
  }

  .dj-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
  }

  .dj-name {
    font-weight: 500;
  }

  .dj-times-form {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
  }

  .time-inputs {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
  }

  .time-input {
    width: 100px;
    padding: var(--space-xs);
    font-size: var(--text-sm);
  }

  .time-separator {
    color: var(--color-muted);
  }

  .inline-form {
    display: inline;
  }

  .tier-form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-sm);
  }

  .add-tier-form,
  .add-dj-form {
    padding-top: var(--space-md);
    border-top: 1px solid var(--color-border);
  }

  .quick-actions {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
  }

  .action-link {
    font-size: var(--text-sm);
  }

  .add-dj-status {
    color: var(--color-muted);
  }

  .add-dj-status.success {
    color: #137333;
  }

  .add-dj-status.error {
    color: #c5221f;
  }
</style>

<script>
  // AJAX DJ form submission to preserve other form state
  const addDjForm = document.getElementById('add-dj-form') as HTMLFormElement;

  if (addDjForm) {
    addDjForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const eventId = addDjForm.dataset.eventId;
      const djSelect = document.getElementById('dj-select') as HTMLSelectElement;
      const newDjName = document.getElementById('new-dj-name') as HTMLInputElement;
      const slotStart = document.getElementById('slot-start') as HTMLInputElement;
      const slotEnd = document.getElementById('slot-end') as HTMLInputElement;
      const submitBtn = document.getElementById('add-dj-btn') as HTMLButtonElement;
      const statusEl = document.getElementById('add-dj-status') as HTMLElement;

      const djId = djSelect?.value || '';
      const newName = newDjName?.value?.trim() || '';

      if (!djId && !newName) {
        statusEl.textContent = 'Select a DJ or enter a new name';
        statusEl.className = 'add-dj-status text-sm ml-sm error';
        return;
      }

      submitBtn.disabled = true;
      statusEl.textContent = 'Adding...';
      statusEl.className = 'add-dj-status text-sm ml-sm';

      try {
        const res = await fetch('/api/admin/event-djs', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            event_id: eventId,
            dj_id: djId || undefined,
            new_dj_name: newName || undefined,
            slot_start: slotStart?.value || undefined,
            slot_end: slotEnd?.value || undefined,
          }),
        });

        const data = await res.json();

        if (res.ok && data.success) {
          // Add the new DJ to the list
          const djsList = document.getElementById('djs-list');
          if (djsList && data.eventDj) {
            const djItem = createDjItemElement(data.eventDj);
            djsList.appendChild(djItem);
          }

          // If a new DJ was created, add to select (if select exists)
          if (data.newDj && djSelect) {
            const option = document.createElement('option');
            option.value = data.newDj.id;
            option.textContent = data.newDj.name;
            djSelect.appendChild(option);
          }

          // Remove the added DJ from select options
          if (djId && djSelect) {
            const option = djSelect.querySelector(`option[value="${djId}"]`);
            if (option) option.remove();
          }

          // Clear form inputs
          if (djSelect) djSelect.value = '';
          if (newDjName) newDjName.value = '';
          if (slotStart) slotStart.value = '';
          if (slotEnd) slotEnd.value = '';

          statusEl.textContent = 'Added!';
          statusEl.className = 'add-dj-status text-sm ml-sm success';
          setTimeout(() => { statusEl.textContent = ''; }, 2000);
        } else {
          statusEl.textContent = data.error || 'Failed to add DJ';
          statusEl.className = 'add-dj-status text-sm ml-sm error';
        }
      } catch (err) {
        statusEl.textContent = 'Network error';
        statusEl.className = 'add-dj-status text-sm ml-sm error';
      }

      submitBtn.disabled = false;
    });
  }

  // Create a DJ item element dynamically
  function createDjItemElement(eventDj: any) {
    const div = document.createElement('div');
    div.className = 'dj-item';
    div.dataset.eventDjId = eventDj.id;

    div.innerHTML = `
      <div class="dj-info">
        <span class="dj-name">${eventDj.dj?.name || 'Unknown'}</span>
        <form method="POST" class="dj-times-form">
          <input type="hidden" name="action" value="update_dj_times" />
          <input type="hidden" name="event_dj_id" value="${eventDj.id}" />
          <div class="time-inputs">
            <input type="time" name="slot_start" value="${eventDj.slot_start || ''}" placeholder="Start" class="time-input" />
            <span class="time-separator">—</span>
            <input type="time" name="slot_end" value="${eventDj.slot_end || ''}" placeholder="End" class="time-input" />
            <button type="submit" class="btn-sm">Save</button>
          </div>
        </form>
      </div>
      <form method="POST" class="inline-form">
        <input type="hidden" name="action" value="remove_dj" />
        <input type="hidden" name="event_dj_id" value="${eventDj.id}" />
        <button type="submit" class="btn-sm secondary">Remove</button>
      </form>
    `;

    return div;
  }
</script>
