---
import Admin from '../../../../layouts/Admin.astro';
import { supabaseAdmin } from '../../../../lib/supabase';
import { createRefund } from '../../../../lib/stripe';

const { id } = Astro.params;

let event: any = null;
let orders: any[] = [];
let error = '';
let success = '';

if (supabaseAdmin && id) {
  // Fetch event
  const { data: eventData } = await supabaseAdmin
    .from('events')
    .select('*')
    .eq('id', id)
    .single();

  event = eventData;

  // Fetch orders
  const { data: ordersData } = await supabaseAdmin
    .from('orders')
    .select('*, tier:ticket_tiers(name)')
    .eq('event_id', id)
    .order('created_at', { ascending: false });

  orders = ordersData || [];
}

// Handle refund
if (Astro.request.method === 'POST' && supabaseAdmin) {
  const formData = await Astro.request.formData();
  const action = formData.get('action');
  const orderId = formData.get('order_id') as string;

  if (action === 'refund') {
    const order = orders.find(o => o.id === orderId);

    if (order && order.stripe_payment_intent_id) {
      try {
        const refundAmount = formData.get('refund_amount');
        await createRefund({
          paymentIntentId: order.stripe_payment_intent_id,
          amount: refundAmount ? parseFloat(refundAmount as string) : undefined,
        });
        success = 'Refund initiated';

        // Refresh orders
        const { data: refreshed } = await supabaseAdmin
          .from('orders')
          .select('*, tier:ticket_tiers(name)')
          .eq('event_id', id)
          .order('created_at', { ascending: false });
        orders = refreshed || [];
      } catch (err: any) {
        error = err.message;
      }
    }
  }
}

if (!event) {
  return Astro.redirect('/admin/events');
}

function formatDate(date: string) {
  return new Date(date).toLocaleDateString('en-US', {
    month: 'short',
    day: 'numeric',
    hour: 'numeric',
    minute: '2-digit',
  });
}

function formatCurrency(amount: number) {
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD',
  }).format(amount);
}

// Calculate totals
const totalRevenue = orders
  .filter(o => o.status === 'completed')
  .reduce((sum, o) => sum + (o.amount_paid - (o.refunded_amount || 0)), 0);

const totalTickets = orders
  .filter(o => o.status === 'completed')
  .reduce((sum, o) => sum + o.quantity, 0);
---

<Admin title={`Orders: ${event.title}`}>
  <div class="page-header-extended">
    <a href={`/admin/events/${id}`} class="back-link text-sm">Back to Event</a>
  </div>

  {error && <p class="error-message mb-lg">{error}</p>}
  {success && <p class="success-message mb-lg">{success}</p>}

  <div class="stats-grid">
    <div class="stat-card">
      <p class="stat-label">Total Revenue</p>
      <p class="stat-value">{formatCurrency(totalRevenue)}</p>
    </div>
    <div class="stat-card">
      <p class="stat-label">Tickets Sold</p>
      <p class="stat-value">{totalTickets}</p>
    </div>
    <div class="stat-card">
      <p class="stat-label">Orders</p>
      <p class="stat-value">{orders.length}</p>
    </div>
  </div>

  {orders.length > 0 ? (
    <table class="admin-table">
      <thead>
        <tr>
          <th>Date</th>
          <th>Customer</th>
          <th>Tier</th>
          <th>Qty</th>
          <th>Amount</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {orders.map(order => (
          <tr>
            <td class="text-sm">{formatDate(order.created_at)}</td>
            <td>
              <div class="customer-info">
                <span class="customer-email">{order.customer_email}</span>
                {order.customer_name && (
                  <span class="customer-name text-sm text-muted">{order.customer_name}</span>
                )}
              </div>
            </td>
            <td>{order.tier?.name}</td>
            <td>{order.quantity}</td>
            <td>
              {formatCurrency(order.amount_paid)}
              {order.refunded_amount > 0 && (
                <span class="refunded text-sm text-muted">
                  (-{formatCurrency(order.refunded_amount)})
                </span>
              )}
            </td>
            <td>
              <span class:list={['status-badge', order.status]}>
                {order.status}
              </span>
            </td>
            <td>
              {order.status === 'completed' && order.stripe_payment_intent_id && (
                <form method="POST" class="refund-form">
                  <input type="hidden" name="action" value="refund" />
                  <input type="hidden" name="order_id" value={order.id} />
                  <button type="submit" class="btn-sm btn-danger" onclick="return confirm('Issue full refund?')">
                    Refund
                  </button>
                </form>
              )}
            </td>
          </tr>
        ))}
      </tbody>
    </table>
  ) : (
    <div class="empty-state">
      <p class="text-muted">No orders yet for this event</p>
    </div>
  )}
</Admin>

<style>
  .page-header-extended {
    margin-bottom: var(--space-lg);
  }

  .back-link {
    color: var(--color-muted);
  }

  .customer-info {
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
  }

  .customer-email {
    font-weight: 500;
  }

  .refunded {
    display: block;
  }

  .refund-form {
    display: inline;
  }

  .status-badge.completed {
    background: #e6f4ea;
    color: #137333;
  }

  .status-badge.refunded {
    background: #fce8e6;
    color: #c5221f;
  }

  .status-badge.partially_refunded {
    background: #fff3cd;
    color: #856404;
  }

  .empty-state {
    background: var(--color-bg);
    padding: var(--space-3xl);
    text-align: center;
  }

  .error-message {
    background: #fce8e6;
    color: #c5221f;
    padding: var(--space-md);
  }

  .success-message {
    background: #e6f4ea;
    color: #137333;
    padding: var(--space-md);
  }
</style>
