---
import Admin from '../../../layouts/Admin.astro';
import { supabaseAdmin } from '../../../lib/supabase';
import { sendCampaign } from '../../../lib/resend';

let subscribers: any[] = [];
let activeCount = 0;
let error = '';
let success = '';

if (supabaseAdmin) {
  // Fetch subscribers
  const { data: subsData, count } = await supabaseAdmin
    .from('newsletter_subscribers')
    .select('*', { count: 'exact' })
    .is('unsubscribed_at', null)
    .order('subscribed_at', { ascending: false });

  subscribers = subsData || [];
  activeCount = count || 0;
}

// Handle form submission - send email blast
if (Astro.request.method === 'POST' && supabaseAdmin) {
  const formData = await Astro.request.formData();
  const subject = formData.get('subject') as string;
  const content = formData.get('content') as string;

  if (!subject || !content) {
    error = 'Subject and content are required';
  } else {
    // Get active subscribers
    const { data: activeSubs } = await supabaseAdmin
      .from('newsletter_subscribers')
      .select('email, unsubscribe_token')
      .is('unsubscribed_at', null);

    let sentCount = 0;
    let failedCount = 0;

    // Send to each subscriber
    for (const sub of activeSubs || []) {
      try {
        await sendCampaign({
          to: sub.email,
          subject: subject,
          htmlContent: content,
          unsubscribeToken: sub.unsubscribe_token,
        });
        sentCount++;
      } catch (err) {
        console.error(`Failed to send to ${sub.email}:`, err);
        failedCount++;
      }
    }

    if (sentCount > 0) {
      success = `Email sent to ${sentCount} subscriber${sentCount !== 1 ? 's' : ''}${failedCount > 0 ? ` (${failedCount} failed)` : ''}`;
    } else {
      error = 'Failed to send emails';
    }
  }
}

function formatDate(date: string) {
  return new Date(date).toLocaleDateString('en-US', {
    month: 'short',
    day: 'numeric',
    year: 'numeric',
  });
}
---

<Admin title="Email">
  {error && <p class="error-message mb-lg">{error}</p>}
  {success && <p class="success-message mb-lg">{success}</p>}

  <div class="content-grid">
    <div class="compose-section">
      <div class="admin-card">
        <div class="admin-card-header">
          <h2 class="admin-card-title">Send Email</h2>
          <span class="subscriber-count">{activeCount} subscriber{activeCount !== 1 ? 's' : ''}</span>
        </div>

        <form method="POST" class="compose-form">
          <div class="form-group">
            <label class="form-label">Subject</label>
            <input type="text" name="subject" required placeholder="Your email subject" />
          </div>

          <div class="form-group">
            <label class="form-label">Content</label>
            <textarea name="content" rows="12" required placeholder="Write your email content here...

You can use basic HTML tags like <p>, <a>, <strong>, etc."></textarea>
            <p class="form-hint">Unsubscribe link is added automatically.</p>
          </div>

          <div class="form-actions">
            <button type="submit" onclick={`return confirm('Send this email to ${activeCount} subscribers?')`}>
              Send to All Subscribers
            </button>
          </div>
        </form>
      </div>
    </div>

    <div class="subscribers-section">
      <div class="admin-card">
        <div class="admin-card-header">
          <h2 class="admin-card-title">Subscribers</h2>
        </div>

        {subscribers.length > 0 ? (
          <div class="subscribers-list">
            {subscribers.slice(0, 20).map(sub => (
              <div class="subscriber-item">
                <span class="subscriber-email">{sub.email}</span>
                <span class="subscriber-date text-muted">{formatDate(sub.subscribed_at)}</span>
              </div>
            ))}
          </div>
        ) : (
          <p class="text-muted text-sm">No subscribers yet</p>
        )}

        {subscribers.length > 20 && (
          <p class="text-sm text-muted mt-md">+ {activeCount - 20} more</p>
        )}
      </div>
    </div>
  </div>
</Admin>

<style>
  .content-grid {
    display: grid;
    grid-template-columns: 1fr 350px;
    gap: var(--space-xl);
    align-items: start;
  }

  @media (max-width: 1024px) {
    .content-grid {
      grid-template-columns: 1fr;
    }
  }

  .subscriber-count {
    font-size: var(--text-sm);
    color: var(--color-muted);
  }

  .compose-form textarea {
    font-family: inherit;
    resize: vertical;
    min-height: 200px;
  }

  .form-actions {
    margin-top: var(--space-lg);
  }

  .subscribers-list {
    display: flex;
    flex-direction: column;
  }

  .subscriber-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-sm) 0;
    border-bottom: 1px solid var(--color-border);
    font-size: var(--text-sm);
  }

  .subscriber-item:last-child {
    border-bottom: none;
  }

  .subscriber-email {
    font-weight: 500;
  }

  .subscriber-date {
    font-size: var(--text-xs);
  }

  .error-message {
    background: #fce8e6;
    color: #c5221f;
    padding: var(--space-md);
  }

  .success-message {
    background: #e6f4ea;
    color: #137333;
    padding: var(--space-md);
  }
</style>
