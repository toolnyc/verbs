---
import Base from '../../layouts/Base.astro';
import Footer from '../../components/public/Footer.astro';
import TicketTier from '../../components/public/TicketTier.astro';
import HouseRulesModal from '../../components/public/HouseRulesModal.astro';
import { getEventWithDetails } from '../../lib/supabase';

const { id } = Astro.params;

if (!id) {
  return Astro.redirect('/');
}

const { event, tiers, djs } = await getEventWithDetails(id);

// Check if user is authenticated
const user = Astro.locals.user;

// Published events: visible to everyone
// Draft events: visible only to authenticated users
// Archived events: not visible on public pages
const canView = event && (
  event.status === 'published' ||
  (event.status === 'draft' && user)
);

if (!canView) {
  return Astro.redirect('/');
}

const isDraft = event.status === 'draft';

const eventDate = new Date(event.date);
const isPast = eventDate < new Date();

const formattedDate = eventDate.toLocaleDateString('en-US', {
  weekday: 'long',
  month: 'long',
  day: 'numeric',
});

// Format time in 24-hour military format with timezone
const formattedTime = eventDate.toLocaleTimeString('en-GB', {
  hour: '2-digit',
  minute: '2-digit',
  hour12: false,
  timeZone: event.timezone || 'America/New_York',
});

// Get short timezone abbreviation
const timezoneAbbr = new Intl.DateTimeFormat('en-US', {
  timeZone: event.timezone || 'America/New_York',
  timeZoneName: 'short',
}).formatToParts(eventDate).find(p => p.type === 'timeZoneName')?.value || '';

const formattedYear = eventDate.getFullYear();

// For countdown - use this event if it's in the future
const nextEventDate = !isPast ? event.date : null;
---

<Base title={`${event.title} - VERBS`} description={event.description || `${event.title} at ${event.venue_name}`}>
  <main class="event-page">
    {isDraft && (
      <div class="draft-banner">
        Draft &mdash; Only visible to logged in users
      </div>
    )}
    <a href="/" class="back-link no-underline">Back</a>

    <div class="event-layout">
      <div class="event-image-wrapper">
        {(event.flyer_url || event.image_url) && (
          <img src={event.flyer_url || event.image_url} alt={event.title} class="event-image" />
        )}
      </div>

      <div class="event-details">
        <header class="event-header">
          <div class="event-meta">
            <span class="date-pill">{formattedDate}</span>
            <span class="year-pill">{formattedYear}</span>
          </div>
          <h1 class="event-title display-text">{event.title}</h1>
        </header>

        <div class="event-info">
          <div class="venue">
            <p class="venue-name">{event.venue_name}</p>
            <p class="venue-city text-muted">{event.venue_city}</p>
            {event.venue_link && (
              <a href={event.venue_link} target="_blank" rel="noopener" class="venue-link text-sm">
                View map &rarr;
              </a>
            )}
          </div>

          <div class="time">
            <p class="time-main">{formattedTime}{event.time_end && ` — ${new Date(event.time_end).toLocaleTimeString('en-GB', {
              hour: '2-digit',
              minute: '2-digit',
              hour12: false,
              timeZone: event.timezone || 'America/New_York',
            })}`} <span class="text-muted">{timezoneAbbr}</span></p>
          </div>

          {djs.length > 0 && (
            <div class="lineup">
              <p class="text-xs text-muted mb-sm">Lineup</p>
              <ul class="dj-list">
                {djs.map((dj: any) => (
                  <li class="dj-name">
                    {dj.name}
                    {(dj.slot_start || dj.slot_end) && (
                      <span class="dj-time text-muted">
                        {dj.slot_start && dj.slot_start.slice(0, 5)}
                        {dj.slot_start && dj.slot_end && ' — '}
                        {dj.slot_end && dj.slot_end.slice(0, 5)}
                      </span>
                    )}
                  </li>
                ))}
              </ul>
            </div>
          )}

          {event.description && (
            <div class="description">
              <p>{event.description}</p>
            </div>
          )}

          {!isPast && tiers.length > 0 && (
            <div class="tickets">
              <p class="text-xs text-muted mb-sm">Tickets</p>
              <div class="ticket-list">
                {tiers.map(tier => (
                  <TicketTier tier={tier} eventId={event.id} />
                ))}
              </div>
            </div>
          )}

          {isPast && (
            <div class="past-event">
              <p class="text-muted text-sm">This event has passed</p>
            </div>
          )}
        </div>
      </div>
    </div>

    {!isPast && tiers.length > 0 && <HouseRulesModal />}
  </main>
  <Footer nextEventDate={nextEventDate} />
</Base>

<style>
  .event-page {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    padding-bottom: var(--space-4xl);
  }

  .draft-banner {
    position: fixed;
    top: 96px; /* Below the floating mixplayer */
    left: 50%;
    transform: translateX(-50%);
    z-index: 200;
    padding: var(--space-sm) var(--space-md);
    background: var(--color-fg);
    color: var(--color-bg);
    text-align: center;
    font-size: var(--text-sm);
    border-radius: 2px;
    width: auto;
  }

  .back-link {
    position: fixed;
    top: 96px; /* Below the floating mixplayer */
    left: var(--space-lg);
    z-index: 100;
    font-size: var(--text-sm);
    padding: var(--space-sm) var(--space-md);
    background: var(--color-bg);
    border: 1px solid var(--color-fg);
    border-radius: 2px;
    transition: background 0.2s, color 0.2s;
  }

  /* When draft banner is present, move back link down */
  .draft-banner ~ .back-link,
  .event-page:has(.draft-banner) .back-link {
    top: 140px;
  }

  .back-link:hover {
    background: var(--color-fg);
    color: var(--color-bg);
  }

  .event-layout {
    flex: 1;
    display: block;
  }

  .event-image-wrapper {
    position: fixed;
    top: 0;
    left: 0;
    width: 50%;
    height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .event-image {
    max-width: 100%;
    max-height: 100%;
    width: auto;
    height: auto;
    object-fit: contain;
  }

  .event-details {
    margin-left: 50%;
    padding: var(--space-4xl);
    display: flex;
    flex-direction: column;
    justify-content: center;
    min-height: 100vh;
  }

  .event-header {
    margin-bottom: var(--space-3xl);
  }

  .event-meta {
    display: flex;
    gap: var(--space-sm);
    margin-bottom: var(--space-lg);
  }

  .date-pill,
  .year-pill {
    display: inline-block;
    font-size: var(--text-xs);
    padding: var(--space-xs) var(--space-md);
    border: 1px solid var(--color-fg);
  }

  .event-title {
    font-size: var(--text-6xl);
  }

  .event-info {
    display: flex;
    flex-direction: column;
    gap: var(--space-xl);
  }

  .venue-name {
    font-size: var(--text-2xl);
    font-weight: 500;
  }

  .venue-link {
    display: inline-block;
    margin-top: var(--space-xs);
  }

  .time-main {
    font-size: var(--text-xl);
  }

  .dj-list {
    list-style: none;
  }

  .dj-name {
    font-size: var(--text-lg);
    padding: var(--space-sm) 0;
    border-bottom: 1px solid var(--color-border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: var(--space-md);
  }

  .dj-name:last-child {
    border-bottom: none;
  }

  .dj-time {
    font-size: var(--text-sm);
    font-variant-numeric: tabular-nums;
  }

  .description {
    max-width: 45ch;
    line-height: 1.6;
  }

  .tickets {
    margin-top: var(--space-lg);
  }

  .ticket-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
  }

  .past-event {
    margin-top: var(--space-lg);
    padding: var(--space-md);
    border: 1px solid var(--color-border);
    text-align: center;
  }

  @media (max-width: 1024px) {
    .event-title {
      font-size: var(--text-5xl);
    }

    .event-details {
      padding: var(--space-2xl);
    }
  }

  @media (max-width: 768px) {
    .event-image-wrapper {
      position: relative;
      width: 100%;
      height: auto;
    }

    .event-image {
      width: 100%;
      height: auto;
      object-fit: contain;
    }

    .back-link {
      position: absolute;
    }

    .event-details {
      margin-left: 0;
      padding: var(--space-xl);
      min-height: auto;
    }

    .event-title {
      font-size: var(--text-4xl);
    }
  }
</style>
