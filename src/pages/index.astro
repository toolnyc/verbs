---
import Base from '../layouts/Base.astro';
import VerbGrid from '../components/public/VerbGrid.astro';
import Footer from '../components/public/Footer.astro';
import { getAllEvents, getPublishedEvents } from '../lib/supabase';
import { listFlyers } from '../lib/blob';

// Check if user is authenticated
const user = Astro.locals.user;

// Fetch events based on auth status:
// - Authenticated users see published + draft events
// - Public users see only published events
const events = user ? await getAllEvents() : await getPublishedEvents();
// Sort descending so newest events appear first
events.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());

// TEST: Override all event images with blob flyer
const flyers = await listFlyers();
// Filter out folder entries (size 0) and get the first actual image
const testFlyerUrl = flyers.find(f => f.size > 0)?.url;
if (testFlyerUrl) {
  events.forEach(e => e.image_url = testFlyerUrl);
}

// Find the next upcoming event (closest future date to today)
const now = new Date();
const upcomingEvents = events
  .filter(e => new Date(e.date) >= now)
  .sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime());
const nextEventId = upcomingEvents.length > 0 ? upcomingEvents[0].id : null;
const nextEventDate = upcomingEvents.length > 0 ? upcomingEvents[0].date : null;

---

<Base title="VERBS" description="Events and mixes from VERBS collective">
  <main>
    <VerbGrid events={events} isAuthenticated={!!user} featuredEventId={nextEventId} />
  </main>
  <Footer nextEventDate={nextEventDate} />
</Base>

<style>
  main {
    display: flex;
    flex-direction: column;
  }
</style>
