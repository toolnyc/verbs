---
import Base from '../layouts/Base.astro';
import Hero from '../components/public/Hero.astro';
import EventList from '../components/public/EventList.astro';
import MixPlayer from '../components/public/MixPlayer.astro';
import NewsletterForm from '../components/public/NewsletterForm.astro';
import { getPublishedEvents, getPublishedMixes, supabase } from '../lib/supabase';

// Fetch all published events
const events = await getPublishedEvents();

// Find next upcoming event for hero
const now = new Date();
const upcomingEvents = events.filter(e => new Date(e.date) >= now);
const heroEvent = upcomingEvents[0] || events[0]; // Fallback to most recent if no upcoming

// Get DJs for hero event
let heroDjs: any[] = [];
if (heroEvent) {
  const { data: eventDjs } = await supabase
    .from('event_djs')
    .select('*, dj:djs(*)')
    .eq('event_id', heroEvent.id)
    .order('sort_order');

  heroDjs = eventDjs?.map(ed => ed.dj).filter(Boolean) || [];
}

// Get hero event tiers
const heroTiers = heroEvent?.ticket_tiers?.filter((t: any) => t.is_active) || [];

// Fetch mixes
const mixes = await getPublishedMixes();
---

<Base title="VERBS" description="Events and mixes from VERBS collective">
  <main>
    <header class="site-header">
      <div class="container">
        <a href="/" class="logo">VERBS</a>
      </div>
    </header>

    {heroEvent ? (
      <Hero event={heroEvent} tiers={heroTiers} djs={heroDjs} />
    ) : (
      <section class="no-events container">
        <h1>Coming soon</h1>
        <p class="text-muted mt-md">Check back for upcoming events.</p>
      </section>
    )}

    {events.length > 1 && (
      <EventList events={events} excludeId={heroEvent?.id} />
    )}

    <MixPlayer mixes={mixes} />

    <NewsletterForm />

    <footer class="site-footer">
      <div class="container">
        <p class="text-sm text-muted">VERBS</p>
      </div>
    </footer>
  </main>
</Base>

<style>
  .site-header {
    padding: var(--space-lg) 0;
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    z-index: 100;
  }

  .logo {
    font-size: var(--text-lg);
    font-weight: 500;
    text-decoration: none;
    letter-spacing: 0.1em;
  }

  .no-events {
    min-height: 60vh;
    display: flex;
    flex-direction: column;
    justify-content: center;
    padding: var(--space-4xl) 0;
  }

  .no-events h1 {
    font-size: var(--text-6xl);
  }

  .site-footer {
    padding: var(--space-2xl) 0;
    border-top: 1px solid var(--color-border);
  }
</style>
