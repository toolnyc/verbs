---
import Base from '../layouts/Base.astro';
import VerbGrid from '../components/public/VerbGrid.astro';
import { getAllEvents, getPublishedEvents } from '../lib/supabase';
import { listFlyers } from '../lib/blob';

// Check if user is authenticated
const user = Astro.locals.user;

// Fetch events based on auth status:
// - Authenticated users see published + draft events
// - Public users see only published events
const events = user ? await getAllEvents() : await getPublishedEvents();
// Sort descending so newest events appear first
events.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());

// TEST: Override all event images with blob flyer
const flyers = await listFlyers();
// Filter out folder entries (size 0) and get the first actual image
const testFlyerUrl = flyers.find(f => f.size > 0)?.url;
if (testFlyerUrl) {
  events.forEach(e => e.image_url = testFlyerUrl);
}

// Find the next upcoming event (closest future date to today)
const now = new Date();
const upcomingEvents = events
  .filter(e => new Date(e.date) >= now)
  .sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime());
const nextEventId = upcomingEvents.length > 0 ? upcomingEvents[0].id : null;
---

<Base title="VERBS" description="Events and mixes from VERBS collective">
  <main>
    <VerbGrid events={events} isAuthenticated={!!user} featuredEventId={nextEventId} />

    <footer class="site-footer">
      <div class="container flex justify-between items-center">
        <a href="/" class="footer-logo no-underline">VERBS</a>
        <p class="text-sm text-muted">&copy; {new Date().getFullYear()}</p>
      </div>
    </footer>
  </main>
</Base>

<style>
  main {
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }

  .site-footer {
    margin-top: auto;
    padding: var(--space-xl) 0;
    border-top: 1px solid var(--color-border);
  }

  .footer-logo {
    font-size: var(--text-lg);
    font-weight: 500;
  }
</style>
