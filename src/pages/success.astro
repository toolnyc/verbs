---
import Base from '../layouts/Base.astro';
import Footer from '../components/public/Footer.astro';
import { stripe } from '../lib/stripe';
import { supabaseAdmin } from '../lib/supabase';
import QRCode from 'qrcode';

const sessionId = Astro.url.searchParams.get('session_id');
const siteUrl = (import.meta.env.PUBLIC_SITE_URL || 'https://www.verbsaroundthe.world').replace(/\/$/, '');

let orderDetails: {
  orderNumber: number | null;
  customerName: string | null;
  customerEmail: string;
  eventTitle: string;
  eventDate: Date;
  eventTimezone: string;
  venueName: string;
  venueCity: string;
  tierName: string;
  quantity: number;
  amountPaid: number;
} | null = null;

let error: string | null = null;

if (!sessionId) {
  error = 'No session ID provided';
} else if (!stripe || !supabaseAdmin) {
  error = 'Service unavailable';
} else {
  try {
    // Retrieve the checkout session from Stripe
    const session = await stripe.checkout.sessions.retrieve(sessionId);

    if (session.payment_status !== 'paid') {
      error = 'Payment not completed';
    } else {
      const eventId = session.metadata?.event_id;
      const tierId = session.metadata?.ticket_tier_id;
      const quantity = parseInt(session.metadata?.quantity || '1', 10);

      if (!eventId || !tierId) {
        error = 'Order details not found';
      } else {
        // Fetch event, tier, and order details
        const [{ data: event }, { data: tier }, { data: order }] = await Promise.all([
          supabaseAdmin.from('events').select('*').eq('id', eventId).single(),
          supabaseAdmin.from('ticket_tiers').select('name').eq('id', tierId).single(),
          supabaseAdmin.from('orders').select('order_number').eq('stripe_session_id', sessionId).single(),
        ]);

        if (event && tier) {
          orderDetails = {
            orderNumber: order?.order_number || null,
            customerName: session.customer_details?.name || null,
            customerEmail: session.customer_details?.email || '',
            eventTitle: event.title,
            eventDate: new Date(event.date),
            eventTimezone: event.timezone || 'America/New_York',
            venueName: event.venue_name,
            venueCity: event.venue_city,
            tierName: tier.name,
            quantity,
            amountPaid: (session.amount_total || 0) / 100,
          };
        } else {
          error = 'Event details not found';
        }
      }
    }
  } catch (err) {
    console.error('Error retrieving session:', err);
    error = 'Could not retrieve order details';
  }
}

const formattedDate = orderDetails?.eventDate.toLocaleDateString('en-US', {
  weekday: 'long',
  month: 'long',
  day: 'numeric',
  year: 'numeric',
});

const formattedTime = orderDetails?.eventDate.toLocaleTimeString('en-GB', {
  hour: '2-digit',
  minute: '2-digit',
  hour12: false,
  timeZone: orderDetails?.eventTimezone,
});

// Generate QR code data URL
const verifyUrl = orderDetails?.orderNumber
  ? `${siteUrl}/verify?order=${orderDetails.orderNumber}`
  : null;
let qrCodeDataUrl: string | null = null;
if (verifyUrl) {
  try {
    qrCodeDataUrl = await QRCode.toDataURL(verifyUrl, {
      width: 200,
      margin: 1,
      color: {
        dark: '#000000',
        light: '#ffffff',
      },
    });
  } catch (err) {
    console.error('Error generating QR code:', err);
  }
}
---

<Base title="Order Confirmed - VERBS" description="Your ticket purchase was successful">
  <main class="success-page">
    <div class="success-content">
      {error ? (
        <div class="error-state">
          <h1 class="display-text">Something went wrong</h1>
          <p class="text-muted mt-lg">{error}</p>
          <a href="/" class="back-button mt-xl">Back to events</a>
        </div>
      ) : orderDetails && (
        <div class="success-state">
          <div class="success-header">
            <p class="text-sm text-muted">Order confirmed</p>
            <h1 class="display-text mt-sm">You're in</h1>
            {orderDetails.orderNumber && (
              <p class="order-number mt-md">Order #{orderDetails.orderNumber}</p>
            )}
          </div>

          {qrCodeDataUrl && (
            <div class="qr-section mt-xl">
              <img src={qrCodeDataUrl} alt="Order QR Code" class="qr-code" width="150" height="150" />
              <p class="text-xs text-muted mt-sm">Show this at the door</p>
            </div>
          )}

          <div class="order-details mt-xl">
            <div class="detail-row">
              <span class="detail-label text-sm text-muted">Event</span>
              <span class="detail-value text-2xl">{orderDetails.eventTitle}</span>
            </div>

            <div class="detail-row">
              <span class="detail-label text-sm text-muted">Date</span>
              <span class="detail-value">{formattedDate}</span>
            </div>

            <div class="detail-row">
              <span class="detail-label text-sm text-muted">Time</span>
              <span class="detail-value">{formattedTime}</span>
            </div>

            <div class="detail-row">
              <span class="detail-label text-sm text-muted">Venue</span>
              <span class="detail-value">{orderDetails.venueName}, {orderDetails.venueCity}</span>
            </div>

            <div class="detail-row">
              <span class="detail-label text-sm text-muted">Ticket</span>
              <span class="detail-value">{orderDetails.tierName} &times; {orderDetails.quantity}</span>
            </div>

            <div class="detail-row">
              <span class="detail-label text-sm text-muted">Total</span>
              <span class="detail-value">${orderDetails.amountPaid.toFixed(2)}</span>
            </div>
          </div>

          <div class="confirmation-note mt-xl">
            <p class="text-sm text-muted">
              A confirmation email has been sent to <strong>{orderDetails.customerEmail}</strong>
            </p>
          </div>

          <div class="action-buttons mt-xl">
            <button type="button" class="print-button" onclick="window.print()">Save / Print</button>
            <a href="/" class="back-button">Back to events</a>
          </div>
        </div>
      )}
    </div>
  </main>
  <Footer />
</Base>

<style>
  .success-page {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: var(--space-xl);
  }

  .success-content {
    width: 100%;
    max-width: 500px;
  }

  .error-state,
  .success-state {
    text-align: center;
  }

  .success-header .display-text {
    font-size: var(--text-5xl);
  }

  .order-number {
    font-size: var(--text-lg);
    font-weight: 500;
    font-variant-numeric: tabular-nums;
  }

  .qr-section {
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .qr-code {
    border: 1px solid var(--color-border);
    padding: var(--space-sm);
    background: white;
  }

  .order-details {
    text-align: left;
    border-top: 1px solid var(--color-border);
  }

  .detail-row {
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
    padding: var(--space-lg) 0;
    border-bottom: 1px solid var(--color-border);
  }

  .detail-value {
    font-size: var(--text-lg);
  }

  .confirmation-note {
    padding: var(--space-lg);
    background: var(--color-bg-alt);
  }

  .confirmation-note strong {
    color: var(--color-fg);
  }

  .action-buttons {
    display: flex;
    gap: var(--space-md);
    justify-content: center;
    flex-wrap: wrap;
  }

  .print-button,
  .back-button {
    display: inline-block;
    padding: var(--space-sm) var(--space-lg);
    border: 1px solid var(--color-fg);
    font-weight: 500;
    transition: background 0.15s, color 0.15s;
    cursor: pointer;
    font-size: inherit;
    font-family: inherit;
  }

  .print-button {
    background: var(--color-bg);
    color: var(--color-fg);
  }

  .print-button:hover {
    background: var(--color-fg);
    color: var(--color-bg);
  }

  .back-button {
    background: var(--color-fg);
    color: var(--color-bg);
  }

  .back-button:hover {
    background: var(--color-bg);
    color: var(--color-fg);
  }

  .back-button::after {
    display: none;
  }

  @media (max-width: 768px) {
    .success-header .display-text {
      font-size: var(--text-4xl);
    }
  }

  /* Print styles */
  @media print {
    .success-page {
      min-height: auto;
      padding: 0;
    }

    .site-footer,
    .action-buttons,
    .noise-overlay {
      display: none !important;
    }

    .success-content {
      max-width: 100%;
    }

    .qr-code {
      width: 120px;
      height: 120px;
    }

    .order-details {
      page-break-inside: avoid;
    }
  }
</style>
