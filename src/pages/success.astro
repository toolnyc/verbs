---
import Base from '../layouts/Base.astro';
import Footer from '../components/public/Footer.astro';
import { stripe } from '../lib/stripe';
import { supabaseAdmin } from '../lib/supabase';

const sessionId = Astro.url.searchParams.get('session_id');

let orderDetails: {
  customerName: string | null;
  customerEmail: string;
  eventTitle: string;
  eventDate: Date;
  eventTimezone: string;
  venueName: string;
  venueCity: string;
  tierName: string;
  quantity: number;
  amountPaid: number;
} | null = null;

let error: string | null = null;

if (!sessionId) {
  error = 'No session ID provided';
} else if (!stripe || !supabaseAdmin) {
  error = 'Service unavailable';
} else {
  try {
    // Retrieve the checkout session from Stripe
    const session = await stripe.checkout.sessions.retrieve(sessionId);

    if (session.payment_status !== 'paid') {
      error = 'Payment not completed';
    } else {
      const eventId = session.metadata?.event_id;
      const tierId = session.metadata?.ticket_tier_id;
      const quantity = parseInt(session.metadata?.quantity || '1', 10);

      if (!eventId || !tierId) {
        error = 'Order details not found';
      } else {
        // Fetch event and tier details
        const [{ data: event }, { data: tier }] = await Promise.all([
          supabaseAdmin.from('events').select('*').eq('id', eventId).single(),
          supabaseAdmin.from('ticket_tiers').select('name').eq('id', tierId).single(),
        ]);

        if (event && tier) {
          orderDetails = {
            customerName: session.customer_details?.name || null,
            customerEmail: session.customer_details?.email || '',
            eventTitle: event.title,
            eventDate: new Date(event.date),
            eventTimezone: event.timezone || 'America/New_York',
            venueName: event.venue_name,
            venueCity: event.venue_city,
            tierName: tier.name,
            quantity,
            amountPaid: (session.amount_total || 0) / 100,
          };
        } else {
          error = 'Event details not found';
        }
      }
    }
  } catch (err) {
    console.error('Error retrieving session:', err);
    error = 'Could not retrieve order details';
  }
}

const formattedDate = orderDetails?.eventDate.toLocaleDateString('en-US', {
  weekday: 'long',
  month: 'long',
  day: 'numeric',
  year: 'numeric',
});

const formattedTime = orderDetails?.eventDate.toLocaleTimeString('en-GB', {
  hour: '2-digit',
  minute: '2-digit',
  hour12: false,
  timeZone: orderDetails?.eventTimezone,
});
---

<Base title="Order Confirmed - VERBS" description="Your ticket purchase was successful">
  <main class="success-page">
    <div class="success-content">
      {error ? (
        <div class="error-state">
          <h1 class="display-text">Something went wrong</h1>
          <p class="text-muted mt-lg">{error}</p>
          <a href="/" class="back-button mt-xl">Back to events</a>
        </div>
      ) : orderDetails && (
        <div class="success-state">
          <div class="success-header">
            <p class="text-sm text-muted">Order confirmed</p>
            <h1 class="display-text mt-sm">You're in</h1>
          </div>

          <div class="order-details mt-3xl">
            <div class="detail-row">
              <span class="detail-label text-sm text-muted">Event</span>
              <span class="detail-value text-2xl">{orderDetails.eventTitle}</span>
            </div>

            <div class="detail-row">
              <span class="detail-label text-sm text-muted">Date</span>
              <span class="detail-value">{formattedDate}</span>
            </div>

            <div class="detail-row">
              <span class="detail-label text-sm text-muted">Time</span>
              <span class="detail-value">{formattedTime}</span>
            </div>

            <div class="detail-row">
              <span class="detail-label text-sm text-muted">Venue</span>
              <span class="detail-value">{orderDetails.venueName}, {orderDetails.venueCity}</span>
            </div>

            <div class="detail-row">
              <span class="detail-label text-sm text-muted">Ticket</span>
              <span class="detail-value">{orderDetails.tierName} &times; {orderDetails.quantity}</span>
            </div>

            <div class="detail-row">
              <span class="detail-label text-sm text-muted">Total</span>
              <span class="detail-value">${orderDetails.amountPaid.toFixed(2)}</span>
            </div>
          </div>

          <div class="confirmation-note mt-3xl">
            <p class="text-sm text-muted">
              A confirmation email has been sent to <strong>{orderDetails.customerEmail}</strong>
            </p>
          </div>

          <a href="/" class="back-button mt-xl">Back to events</a>
        </div>
      )}
    </div>
  </main>
  <Footer />
</Base>

<style>
  .success-page {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: var(--space-xl);
  }

  .success-content {
    width: 100%;
    max-width: 500px;
  }

  .error-state,
  .success-state {
    text-align: center;
  }

  .success-header .display-text {
    font-size: var(--text-5xl);
  }

  .order-details {
    text-align: left;
    border-top: 1px solid var(--color-border);
  }

  .detail-row {
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
    padding: var(--space-lg) 0;
    border-bottom: 1px solid var(--color-border);
  }

  .detail-value {
    font-size: var(--text-lg);
  }

  .confirmation-note {
    padding: var(--space-lg);
    background: var(--color-bg-alt);
  }

  .confirmation-note strong {
    color: var(--color-fg);
  }

  .back-button {
    display: inline-block;
    padding: var(--space-sm) var(--space-lg);
    border: 1px solid var(--color-fg);
    background: var(--color-fg);
    color: var(--color-bg);
    font-weight: 500;
    transition: background 0.15s, color 0.15s;
  }

  .back-button:hover {
    background: var(--color-bg);
    color: var(--color-fg);
  }

  .back-button::after {
    display: none;
  }

  @media (max-width: 768px) {
    .success-header .display-text {
      font-size: var(--text-4xl);
    }
  }
</style>
